#ifndef _IMU_H_
#define _IMU_H_

//头文件包含
#include "zf_common_headfile.h"

//宏定义

#define IMU_SAMPLE_RATE          200              // IMU采样频率(Hz)
#define DT                      (1.0f / IMU_SAMPLE_RATE)   // 采样周期(s)

//四元数结构体
typedef struct
{
    float q0;                    // w
    float q1;                    // x
    float q2;                    // y
    float q3;                    // z
} Quaternion;

//欧拉角结构体
typedef struct
{
    float roll;                  // 横滚角(绕X轴旋转) 单位:度
    float pitch;                 // 俯仰角(绕Y轴旋转) 单位:度
    float yaw;                   // 偏航角(绕Z轴旋转) 单位:度
} EulerAngles;

//IMU数据结构体
typedef struct
{
    float acc_x;                 // 加速度计X轴数据 单位:g
    float acc_y;                 // 加速度计Y轴数据 单位:g
    float acc_z;                 // 加速度计Z轴数据 单位:g

    float gyro_x;                // 陀螺仪X轴数据 单位:°/s
    float gyro_y;                // 陀螺仪Y轴数据 单位:°/s
    float gyro_z;                // 陀螺仪Z轴数据 单位:°/s

    Quaternion quat;             // 四元数
    EulerAngles euler;           // 欧拉角
} IMUData;

//全局变量声明
extern IMUData imu;

//函数声明

//-------------------------------------------------------------------------------------------------------------------
// 函数简介     IMU初始化
// 参数说明     void
// 返回参数     uint8           0-初始化成功 1-初始化失败
// 使用示例     uint8 result = imu_init();
// 备注信息     内部调用imu660rb_init()
//-------------------------------------------------------------------------------------------------------------------
uint8 imu_init(void);

//-------------------------------------------------------------------------------------------------------------------
// 函数简介     IMU数据更新
// 参数说明     void
// 返回参数     void
// 使用示例     imu_update();
// 备注信息     获取原始数据并进行四元数解算，需要周期调用(建议10ms)
//-------------------------------------------------------------------------------------------------------------------
void imu_update(void);

//-------------------------------------------------------------------------------------------------------------------
// 函数简介     获取IMU原始数据
// 参数说明     void
// 返回参数     void
// 使用示例     imu_get_data();
// 备注信息     从imu660rb获取加速度计和陀螺仪数据并转换为物理单位
//-------------------------------------------------------------------------------------------------------------------
void imu_get_data(void);

//-------------------------------------------------------------------------------------------------------------------
// 函数简介     四元数初始化
// 参数说明     void
// 返回参数     void
// 使用示例     imu_quaternion_init();
// 备注信息     使用加速度计初始值初始化四元数
//-------------------------------------------------------------------------------------------------------------------
void imu_quaternion_init(void);

//-------------------------------------------------------------------------------------------------------------------
// 函数简介     四元数更新(互补滤波算法)
// 参数说明     void
// 返回参数     void
// 使用示例     imu_quaternion_update();
// 备注信息     使用互补滤波算法融合加速度计和陀螺仪数据更新四元数
//-------------------------------------------------------------------------------------------------------------------
void imu_quaternion_update(void);

//-------------------------------------------------------------------------------------------------------------------
// 函数简介     四元数转欧拉角
// 参数说明     void
// 返回参数     void
// 使用示例     imu_quaternion_to_euler();
// 备注信息     将四元数转换为欧拉角(roll,pitch,yaw)
//-------------------------------------------------------------------------------------------------------------------
void imu_quaternion_to_euler(void);

//-------------------------------------------------------------------------------------------------------------------
// 函数简介     快速平方根倒数
// 参数说明     x               输入值
// 返回参数     float           1/sqrt(x)
// 使用示例     float y = fast_inv_sqrt(x);
// 备注信息     使用快速算法计算平方根倒数
//-------------------------------------------------------------------------------------------------------------------
float fast_inv_sqrt(float x);

//-------------------------------------------------------------------------------------------------------------------
// 函数简介     角度归一化
// 参数说明     angle           角度值
// 返回参数     float           归一化后的角度(-180~180)
// 使用示例     float angle = angle_normalize(angle);
// 备注信息     将角度归一化到-180~180度范围
//-------------------------------------------------------------------------------------------------------------------
float angle_normalize(float angle);

#endif
