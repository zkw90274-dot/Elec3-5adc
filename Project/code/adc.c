//-------------------------------------------------------------------------------------------------------------------
// 头文件包含
//-------------------------------------------------------------------------------------------------------------------
#include "adc.h"

//-------------------------------------------------------------------------------------------------------------------
// 全局变量定义
//-------------------------------------------------------------------------------------------------------------------
uint16 adc_val_list[CHANNEL_NUMBER] = {0};                      // ADC原始值数组
uint8 channel_index = 0;                                        // 当前通道索引

// ADC通道枚举数组 - 按从左到右顺序排列
adc_channel_enum channel_list[CHANNEL_NUMBER] =
{
    ADC_L1, ADC_L2, ADC_M3, ADC_R4, ADC_R5
};

// ADC最大最小值校准数组 [偶数索引=最大值, 奇数索引=最小值]
// 需要根据实际传感器校准修改这些值
uint16 max_min_adc[2*CHANNEL_NUMBER] = {
    3532, 0,     // L1: 最大值, 最小值
    3522, 0,     // L2: 最大值, 最小值
    3550, 0,     // M3: 最大值, 最小值
    3516, 0,     // R4: 最大值, 最小值
    3548, 0,     // R5: 最大值, 最小值
};

//-------------------------------------------------------------------------------------------------------------------
// 函数简介     ADC全部通道初始化
// 参数说明     void
// 返回参数     void
// 使用示例     Adc_All_Init();
// 备注信息     初始化5个ADC通道为12位精度
//-------------------------------------------------------------------------------------------------------------------
void Adc_All_Init(void)
{
    adc_init(ADC_L1, ADC_12BIT);         // L1 左侧传感器1
    adc_init(ADC_L2, ADC_12BIT);         // L2 左侧传感器2
    adc_init(ADC_M3, ADC_12BIT);         // M3 中间传感器
    adc_init(ADC_R4, ADC_12BIT);         // R4 右侧传感器4
    adc_init(ADC_R5, ADC_12BIT);         // R5 右侧传感器5
}

//-------------------------------------------------------------------------------------------------------------------
// 函数简介     ADC值限幅
// 参数说明     adc_val         ADC原始值
// 参数说明     index           通道索引 (0-4)
// 返回参数     uint16          限幅后的ADC值
// 使用示例     uint16 val = limit(adc_val, 0);
// 备注信息     将ADC值限制在校准的最大最小值范围内
//-------------------------------------------------------------------------------------------------------------------
uint16 limit(uint16 adc_val, uint8 index)
{
    if(adc_val > max_min_adc[2*index])
    {
        adc_val = max_min_adc[2*index];
    }
    if(adc_val < max_min_adc[2*index+1])
    {
        adc_val = max_min_adc[2*index+1];
    }
    return adc_val;
}

//-------------------------------------------------------------------------------------------------------------------
// 函数简介     ADC测试函数
// 参数说明     void
// 返回参数     void
// 使用示例     Adc_Test();
// 备注信息     打印所有通道的ADC原始值和平均值滤波后的值
//-------------------------------------------------------------------------------------------------------------------
void Adc_Test(void)
{
    // 打印原始转换值
    for(channel_index = 0; channel_index < CHANNEL_NUMBER; channel_index++)
    {
        printf("ADC channel %d convert data is %d.\r\n",
               channel_index + 1,
               adc_convert(channel_list[channel_index]));
    }
    system_delay_ms(1000);

    // 打印平均值滤波后的值
    for(channel_index = 0; channel_index < CHANNEL_NUMBER; channel_index++)
    {
        printf("ADC channel %d mean filter convert data is %d.\r\n",
               channel_index + 1,
               adc_mean_filter_convert(channel_list[channel_index], 10));
    }
    system_delay_ms(500);
}

//-------------------------------------------------------------------------------------------------------------------
// 函数简介     获取所有ADC值并限幅 (使用简单平均滤波)
// 参数说明     void
// 返回参数     void
// 使用示例     Adc_Getval();
// 备注信息     获取5个通道的ADC值，进行10次平均值滤波并限幅
//              结果保存在 adc_val_list[] 数组中
//-------------------------------------------------------------------------------------------------------------------
void Adc_Getval(void)
{
    for(channel_index = 0; channel_index < CHANNEL_NUMBER; channel_index++)
    {
        // 获取ADC值 -> 10次平均值滤波 -> 限幅
        adc_val_list[channel_index] = limit(
            adc_mean_filter_convert(channel_list[channel_index], 10),
            channel_index
        );
    }
}

//-------------------------------------------------------------------------------------------------------------------
// 函数简介     获取所有ADC值 - 中值滤波版本
// 参数说明     void
// 返回参数     void
// 使用示例     Adc_Getval_Mid();
// 备注信息     使用中值滤波获取ADC值并限幅，适合去除脉冲干扰
//              结果保存在 adc_val_list[] 数组中
//-------------------------------------------------------------------------------------------------------------------
void Adc_Getval_Mid(void)
{
    for(channel_index = 0; channel_index < CHANNEL_NUMBER; channel_index++)
    {
        // 中值滤波 -> 限幅
        adc_val_list[channel_index] = limit(
            adc_mid_sample(channel_list[channel_index]),
            channel_index
        );
    }
}

//-------------------------------------------------------------------------------------------------------------------
// 函数简介     获取所有ADC值 - 去极值平均滤波版本
// 参数说明     void
// 返回参数     void
// 使用示例     Adc_Getval_Avg();
// 备注信息     使用去极值平均滤波获取ADC值并限幅，抗干扰能力强
//              结果保存在 adc_val_list[] 数组中
//-------------------------------------------------------------------------------------------------------------------
void Adc_Getval_Avg(void)
{
    for(channel_index = 0; channel_index < CHANNEL_NUMBER; channel_index++)
    {
        // 去极值平均滤波 -> 限幅
        adc_val_list[channel_index] = limit(
            adc_sample(channel_list[channel_index]),
            channel_index
        );
    }
}

//-------------------------------------------------------------------------------------------------------------------
// 函数简介     获取所有ADC值 - 组合滤波版本 (推荐)
// 参数说明     void
// 返回参数     void
// 使用示例     Adc_Getval_Combined();
// 备注信息     使用中值+去极值组合滤波获取ADC值并限幅
//              双重滤波，最强的抗干扰能力，适合强干扰环境
//              结果保存在 adc_val_list[] 数组中
//-------------------------------------------------------------------------------------------------------------------
void Adc_Getval_Combined(void)
{
    for(channel_index = 0; channel_index < CHANNEL_NUMBER; channel_index++)
    {
        // 组合滤波 -> 限幅
        adc_val_list[channel_index] = limit(
            adc_sample_b(channel_list[channel_index]),
            channel_index
        );
    }
}

//===================================================================================================================
// 多重滤波策略实现
//===================================================================================================================

//-------------------------------------------------------------------------------------------------------------------
// 函数简介     中值滤波 (三次采样取中值)
// 参数说明     ch              ADC通道枚举
// 返回参数     uint16          中值滤波后的ADC值
// 使用示例     uint16 val = adc_mid_sample(ADC_L1);
// 备注信息     连续采样3次，取中间值，有效去除脉冲干扰
//-------------------------------------------------------------------------------------------------------------------
uint16 adc_mid_sample(adc_channel_enum ch)
{
    uint16 i, j, k, tmp;

    // 采样3次
    i = adc_convert(ch);
    j = adc_convert(ch);
    k = adc_convert(ch);

    // 选择中值 (三数排序取中间值)
    if(i > j)
    {
        tmp = i;
        i = j;
        j = tmp;
    }
    if(k > j)
    {
        tmp = j;
    }
    else if(k > i)
    {
        tmp = k;
    }
    else
    {
        tmp = i;
    }

    return tmp;
}

//-------------------------------------------------------------------------------------------------------------------
// 函数简介     去极值平均滤波 (采样11次，去掉最大最小后取平均)
// 参数说明     ch              ADC通道枚举
// 返回参数     uint16          滤波后的ADC值
// 使用示例     uint16 val = adc_sample(ADC_L1);
// 备注信息     采样11次，去除1个最大值和1个最小值，剩余9个取平均
//              优点: 去除极值干扰，平滑信号
//-------------------------------------------------------------------------------------------------------------------
uint16 adc_sample(adc_channel_enum ch)
{
    uint16 temp, sum, max, min;
    uint8 i;

    // 第一次采样
    temp = adc_convert(ch);
    max = temp;
    min = temp;
    sum = temp;

    // 继续采样10次
    for(i = 0; i < 10; i++)
    {
        temp = adc_convert(ch);
        if(max < temp)
        {
            max = temp;
        }
        if(min > temp)
        {
            min = temp;
        }
        sum += temp;
    }

    // 去掉最大值和最小值后求平均 (11-2=9)
    temp = (sum - max - min) / 9;

    return temp;
}

//-------------------------------------------------------------------------------------------------------------------
// 函数简介     中值+去极值组合滤波 (中值滤波后再去极值平均)
// 参数说明     ch              ADC通道枚举
// 返回参数     uint16          滤波后的ADC值
// 使用示例     uint16 val = adc_sample_b(ADC_L1);
// 备注信息     先进行三次中值滤波，连续8次中值后再去极值平均
//              优点: 双重滤波，更强的抗干扰能力
//-------------------------------------------------------------------------------------------------------------------
uint16 adc_sample_b(adc_channel_enum ch)
{
    uint16 temp, sum, max, min;
    uint8 i;

    // 第一次中值滤波
    temp = adc_mid_sample(ch);
    max = temp;
    min = temp;
    sum = temp;

    // 继续进行7次中值滤波
    for(i = 1; i <= 7; i++)
    {
        temp = adc_mid_sample(ch);
        if(max < temp)
        {
            max = temp;
        }
        if(min > temp)
        {
            min = temp;
        }
        sum += temp;
    }

    // 去掉最大值和最小值后求平均 (8-2=6)
    temp = (sum - max - min) / 6;

    return temp;
}

//-------------------------------------------------------------------------------------------------------------------
// 函数简介     7元素冒泡排序
// 参数说明     arr             7元素数组指针
// 返回参数     uint16          排序后数组的首地址
// 使用示例     arr[0] = sort_seven(arr);
// 备注信息     对7个元素进行冒泡排序，中值位于arr[3]
//-------------------------------------------------------------------------------------------------------------------
uint16 sort_seven(uint16 arr[])
{
    uint8 i, j;
    uint16 temp;

    // 冒泡排序 (降序)
    for(i = 0; i < 6; i++)
    {
        for(j = 0; j < 6 - i; j++)
        {
            if(arr[j] < arr[j + 1])
            {
                temp = arr[j];
                arr[j] = arr[j + 1];
                arr[j + 1] = temp;
            }
        }
    }

    // 返回中值 arr[3]
    return arr[3];
}

//-------------------------------------------------------------------------------------------------------------------
// 函数简介     排序取中值滤波 (7次采样排序后取中值)
// 参数说明     ch              ADC通道枚举
// 返回参数     uint16          中值
// 使用示例     uint16 val = adc_sample_a(ADC_L1);
// 备注信息     采样7次，排序后取第4个值(中值)
//-------------------------------------------------------------------------------------------------------------------
uint16 adc_sample_a(adc_channel_enum ch)
{
    uint8 i;
    uint16 arr[7];

    // 采样7次
    for(i = 0; i < 7; i++)
    {
        arr[i] = adc_convert(ch);
    }

    // 排序并返回中值
    arr[0] = sort_seven(arr);
    return arr[0];
}
