#ifndef _PID_H_
#define _PID_H_

//头文件包含
#include "zf_common_headfile.h"
#include "quaternion.h"

//宏定义
#define PID_OUTPUT_MAX      (60)       // PID输出最大值(对应PWM占空比百分比)
#define PID_OUTPUT_MIN      (-60)      // PID输出最小值
#define PID_INTEGRAL_MAX    (400)      // 积分限幅值

/*==================================================================================================================*/
/* =============== 传统 PID 控制器 (速度环) =============== */
/*==================================================================================================================*/

// PID参数结构体
typedef struct
{
    float kp;                   // 比例系数
    float ki;                   // 积分系数
    float kd;                   // 微分系数

    float target;               // 目标值
    float actual;               // 实际值
    float error;                // 当前误差
    float last_error;           // 上次误差
    float prev_error;           // 上上次误差

    float out_p;                // 比例输出
    float out_i;                // 积分输出
    float out_d;                // 微分输出
    float out;                  // PID总输出

    float integrator;           // 积分累计值
    float integral_max;         // 积分限幅值
    float output_max;           // 输出最大值
    float output_min;           // 输出最小值

} pid_param_t;

// 外部变量声明
extern pid_param_t pid_motor_left;      // 左电机PID控制器
extern pid_param_t pid_motor_right;     // 右电机PID控制器
extern pid_param_t pid_SDSD;             // 差比和差PID控制器

/*==================================================================================================================*/
/* =============== 四元数姿态控制 (替代欧拉角) =============== */
/*==================================================================================================================*/

/**
 * @brief       四元数姿态控制器结构体
 * @note        直接使用四元数进行姿态控制，避免万向锁问题
 */
typedef struct
{
    // 目标姿态 (用欧拉角指定，内部转为四元数)
    float target_roll;           // 目标横滚角 (度)
    float target_pitch;          // 目标俯仰角 (度)
    float target_yaw;            // 目标偏航角 (度)

    // 目标四元数 (从欧拉角转换)
    float target_q0;
    float target_q1;
    float target_q2;
    float target_q3;

    // 方向环参数 (位置误差 → 角速度)
    float kp_direction;          // 方向环比例系数
    float kd_direction;          // 方向环微分系数

    // 角速度环参数 (角速度误差 → 电机)
    float kp_gyro;               // 角速度环比例系数
    float kd_gyro;               // 角速度环微分系数

    // 历史数据
    float last_error_gyro;       // 上次角速度误差

} quaternion_attitude_t;

// 外部变量声明
extern quaternion_attitude_t attitude_controller;  // 四元数姿态控制器

/*==================================================================================================================*/
/* =============== 传统 PD 控制器 (兼容保留) =============== */
/*==================================================================================================================*/

// PD控制器结构体(用于角度环/角速度环/方向环) - 兼容保留
typedef struct
{
    float kp;                   // 比例系数
    float kd;                   // 微分系数
    float kp_gyro;              // 角速度环比例系数
    float kd_gyro;              // 角速度环微分系数
} pd_param_t;

// PD控制器变量声明
extern pd_param_t pd_direction;          // 方向环PD参数

/*==================================================================================================================*/
/* =============== 传统 PID 函数 (速度环) =============== */
/*==================================================================================================================*/

//-------------------------------------------------------------------------------------------------------------------
// 函数简介     PID参数初始化
//-------------------------------------------------------------------------------------------------------------------
void pid_init(pid_param_t *pid, float kp, float ki, float kd);

//-------------------------------------------------------------------------------------------------------------------
// 函数简介     设置PID参数
//-------------------------------------------------------------------------------------------------------------------
void pid_set_param(pid_param_t *pid, float kp, float ki, float kd);


//-------------------------------------------------------------------------------------------------------------------
// 函数简介     位置式PID计算
//-------------------------------------------------------------------------------------------------------------------
float pid_calc_position(pid_param_t *pid, float actual);

//-------------------------------------------------------------------------------------------------------------------
// 函数简介     增量式PID计算
//-------------------------------------------------------------------------------------------------------------------
float pid_calc_increment(pid_param_t *pid, float actual);

//-------------------------------------------------------------------------------------------------------------------
// 函数简介     限幅函数
//-------------------------------------------------------------------------------------------------------------------
float constrain_float(float value, float min_val, float max_val);

//-------------------------------------------------------------------------------------------------------------------
// 函数简介     电机PID控制函数
//-------------------------------------------------------------------------------------------------------------------
void motor_pid_control(int16 encoder_left, int16 encoder_right);

/*==================================================================================================================*/
/* =============== 四元数姿态控制函数 (新实现) =============== */
/*==================================================================================================================*/

/**
 * @brief       四元数姿态控制器初始化
 * @param       roll            目标横滚角 (度)
 * @param       pitch           目标俯仰角 (度)
 * @param       yaw             目标偏航角 (度)
 * @param       kp_dir          方向环比例系数
 * @param       kd_dir          方向环微分系数
 * @param       kp_gyro         角速度环比例系数
 * @param       kd_gyro         角速度环微分系数
 */
void attitude_init(float roll, float pitch, float yaw,
                   float kp_dir, float kd_dir, float kp_gyro, float kd_gyro);

/**
 * @brief       欧拉角转四元数
 * @param       roll            横滚角 (度)
 * @param       pitch           俯仰角 (度)
 * @param       yaw             偏航角 (度)
 * @param       q0              输出四元数 w 分量
 * @param       q1              输出四元数 x 分量
 * @param       q2              输出四元数 y 分量
 * @param       q3              输出四元数 z 分量
 * @note        ZYX旋转顺序 (航空顺序)
 */
void euler_to_quaternion(float roll, float pitch, float yaw,
                           float *q0, float *q1, float *q2, float *q3);

/**
 * @brief       四元数共轭
 */
void quaternion_conjugate(float *q0, float *q1, float *q2, float *q3);

/**
 * @brief       四元数乘法
 */
void quaternion_multiply(float qa0, float qa1, float qa2, float qa3,
                          float qb0, float qb1, float qb2, float qb3,
                          float *qr0, float *qr1, float *qr2, float *qr3);

/*==================================================================================================================*/
/* =============== 传统 PD 函数 (兼容保留) =============== */
/*==================================================================================================================*/

//-------------------------------------------------------------------------------------------------------------------
// 函数简介     初始化PD控制器参数
//-------------------------------------------------------------------------------------------------------------------
void pd_init(pd_param_t *pd, float kp, float kd, float kp_gyro, float kd_gyro);

//-------------------------------------------------------------------------------------------------------------------
// 函数简介     PD方向环+角速度环组合控制 (推荐用于循迹)
//-------------------------------------------------------------------------------------------------------------------
float pd_direction_gyro_loop(float err_position);

#endif
