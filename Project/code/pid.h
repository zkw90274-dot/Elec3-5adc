#ifndef _PID_H_
#define _PID_H_

//头文件包含
#include "zf_common_headfile.h"

//宏定义
#define PID_OUTPUT_MAX      (60)       // PID输出最大值(对应PWM占空比百分比)
#define PID_OUTPUT_MIN      (-60)      // PID输出最小值
#define PID_INTEGRAL_MAX    (400)      // 积分限幅值

// PID参数结构体
typedef struct
{
    float kp;                   // 比例系数
    float ki;                   // 积分系数
    float kd;                   // 微分系数

    float target;               // 目标值
    float actual;               // 实际值
    float error;                // 当前误差
    float last_error;           // 上次误差
    float prev_error;           // 上上次误差

    float out_p;                // 比例输出
    float out_i;                // 积分输出
    float out_d;                // 微分输出
    float out;                  // PID总输出

    float integrator;           // 积分累计值
    float integral_max;         // 积分限幅值
    float output_max;           // 输出最大值
    float output_min;           // 输出最小值

} pid_param_t;

// PD控制器结构体(用于角度环/角速度环/方向环)
typedef struct
{
    float kp;                   // 比例系数
    float kd;                   // 微分系数
    float kp_gyro;              // 角速度环比例系数
    float kd_gyro;              // 角速度环微分系数
} pd_param_t;

// 外部变量声明
extern pid_param_t pid_motor_left;      // 左电机PID控制器
extern pid_param_t pid_motor_right;     // 右电机PID控制器
extern pid_param_t pid_SDSD;             // 差比和差PID控制器

// PD控制器变量声明
extern pd_param_t pd_direction;          // 方向环PD参数
extern pd_param_t pd_angle;              // 角度环PD参数
extern pd_param_t pd_gyro;               // 角速度环PD参数

// 函数声明
//-------------------------------------------------------------------------------------------------------------------
// 函数简介     PID参数初始化
// 参数说明     pid             PID结构体指针
// 参数说明     kp              比例系数
// 参数说明     ki              积分系数
// 参数说明     kd              微分系数
// 返回参数     void
// 使用示例     pid_init(&pid_motor_left, 1.7, 0.22, 0.2);
// 备注信息     初始化PID控制器的所有参数和状态变量
//-------------------------------------------------------------------------------------------------------------------
void pid_init(pid_param_t *pid, float kp, float ki, float kd);

//-------------------------------------------------------------------------------------------------------------------
// 函数简介     设置PID参数
// 参数说明     pid             PID结构体指针
// 参数说明     kp              比例系数
// 参数说明     ki              积分系数
// 参数说明     kd              微分系数
// 返回参数     void
// 使用示例     pid_set_param(&pid_motor_left, 2.0, 0.3, 0.25);
// 备注信息     动态调整PID参数，不影响其他状态变量
//-------------------------------------------------------------------------------------------------------------------
void pid_set_param(pid_param_t *pid, float kp, float ki, float kd);

//-------------------------------------------------------------------------------------------------------------------
// 函数简介     设置PID目标值
// 参数说明     pid             PID结构体指针
// 参数说明     target          目标值
// 返回参数     void
// 使用示例     pid_set_target(&pid_motor_left, 100);
// 备注信息     设置PID控制器的目标值(注：函数内部对target取负)
//-------------------------------------------------------------------------------------------------------------------
void pid_set_target(pid_param_t *pid, float target);

//-------------------------------------------------------------------------------------------------------------------
// 函数简介     清除PID数据
// 参数说明     pid             PID结构体指针
// 返回参数     void
// 使用示例     pid_clear(&pid_motor_left);
// 备注信息     清除PID的所有误差和输出累计值，用于重启控制或切换模式
//-------------------------------------------------------------------------------------------------------------------
void pid_clear(pid_param_t *pid);

//-------------------------------------------------------------------------------------------------------------------
// 函数简介     位置式PID计算
// 参数说明     pid             PID结构体指针
// 参数说明     actual          当前实际值
// 返回参数     float           PID输出值
// 使用示例     float output = pid_calc_position(&pid_motor_left, encoder_value);
// 备注信息     位置式PID，输出是绝对控制量
//-------------------------------------------------------------------------------------------------------------------
float pid_calc_position(pid_param_t *pid, float actual);

//-------------------------------------------------------------------------------------------------------------------
// 函数简介     增量式PID计算
// 参数说明     pid             PID结构体指针
// 参数说明     actual          当前实际值
// 返回参数     float           PID输出值
// 使用示例     float output = pid_calc_increment(&pid_motor_left, encoder_value);
// 备注信息     增量式PID，输出是控制量的增量，需要累加到之前的输出
//-------------------------------------------------------------------------------------------------------------------
float pid_calc_increment(pid_param_t *pid, float actual);

//-------------------------------------------------------------------------------------------------------------------
// 函数简介     限幅函数
// 参数说明     value           待限幅值
// 参数说明     min_val         最小值
// 参数说明     max_val         最大值
// 返回参数     float           限幅后的值
// 使用示例     float result = constrain_float(value, -100, 100);
// 备注信息     将输入值限制在指定范围内
//-------------------------------------------------------------------------------------------------------------------
float constrain_float(float value, float min_val, float max_val);

//-------------------------------------------------------------------------------------------------------------------
// 函数简介     电机PID控制函数
// 参数说明     encoder_left    左编码器值
// 参数说明     encoder_right   右编码器值
// 返回参数     void
// 使用示例     motor_pid_control(encoder_left, encoder_right);
// 备注信息     在定时中断中调用，根据编码器值计算PWM输出并控制电机
//-------------------------------------------------------------------------------------------------------------------
void motor_pid_control(int16 encoder_left, int16 encoder_right);

//-------------------------------------------------------------------------------------------------------------------
// 函数简介     PD方向环 - 电磁位置误差转期望角速度
// 参数说明     err_position    电磁位置误差
// 返回参数     float           电机差速修正值
// 使用示例     float correction = pd_direction_loop(adc_error);
// 备注信息     输入位置误差 -> PD计算 -> 输出期望角速度 -> 角速度环 -> 输出电机差速
//-------------------------------------------------------------------------------------------------------------------
float pd_direction_loop(float err_position);

//-------------------------------------------------------------------------------------------------------------------
// 函数简介     PD角度环 - 角度误差转期望角速度
// 参数说明     current_angle   当前角度
// 参数说明     target_angle    目标角度
// 返回参数     float           期望角速度
// 使用示例     float expect_gyro = pd_angle_loop(current_yaw, target_yaw);
// 备注信息     输入角度误差 -> PD计算 -> 输出期望角速度
//-------------------------------------------------------------------------------------------------------------------
float pd_angle_loop(float current_angle, float target_angle);

//-------------------------------------------------------------------------------------------------------------------
// 函数简介     PD角速度环 - 角速度误差转电机控制值
// 参数说明     expect_gyro     期望角速度
// 参数说明     actual_gyro     实际角速度
// 返回参数     int16           电机控制值
// 使用示例     int16 output = pd_gyro_loop(expect_gyro, actual_z_gyro);
// 备注信息     输入角速度误差 -> PD计算 -> 输出电机控制量
//-------------------------------------------------------------------------------------------------------------------
int16 pd_gyro_loop(float expect_gyro, float actual_gyro);

//-------------------------------------------------------------------------------------------------------------------
// 函数简介     初始化PD控制器参数
// 参数说明     pd              PD结构体指针
// 参数说明     kp              比例系数
// 参数说明     kd              微分系数
// 参数说明     kp_gyro         角速度环比例系数
// 参数说明     kd_gyro         角速度环微分系数
// 返回参数     void
// 使用示例     pd_init(&pd_direction, 2.5, 0.8, 1.2, 0.3);
// 备注信息     初始化PD控制器的所有参数
//-------------------------------------------------------------------------------------------------------------------
void pd_init(pd_param_t *pd, float kp, float kd, float kp_gyro, float kd_gyro);

//-------------------------------------------------------------------------------------------------------------------
// 函数简介     PD方向环+角速度环组合控制 (推荐用于循迹)
// 参数说明     err_position    位置误差(ADC归一化值-中心值)
// 返回参数     float           电机差速修正值
// 使用示例     float correction = pd_direction_gyro_loop(adc_error);
// 备注信息     位置误差->期望角速度->角速度闭环->电机差速修正值
//              这是PD方向环和角速度环的组合，推荐用于智能车循迹
//-------------------------------------------------------------------------------------------------------------------
float pd_direction_gyro_loop(float err_position);

//-------------------------------------------------------------------------------------------------------------------
// 函数简介     清除PD控制器历史误差
// 参数说明     void
// 返回参数     void
// 使用示例     pd_clear_history();
// 备注信息     清除所有PD控制器的误差历史，用于重启控制或切换模式
//-------------------------------------------------------------------------------------------------------------------
void pd_clear_history(void);

#endif
