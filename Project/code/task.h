#ifndef _TASK_H_
#define _TASK_H_

#include "zf_common_headfile.h"
#include "adc.h"
#include "encoder.h"
#include "IMU.h"
#include "pid.h"
#include "control.h"

//-------------------------------------------------------------------------------------------------------------------
// 控制模式选择宏定义
//-------------------------------------------------------------------------------------------------------------------
#define CONTROL_MODE_SDSD              0       // SDSD控制模式
#define CONTROL_MODE_PD_DIRECTION       1       // PD方向环+角速度环模式

// 当前控制模式 (修改此值切换控制算法)
#define CONTROL_MODE_CURRENT           CONTROL_MODE_SDSD    // 默认使用SDSD
// #define CONTROL_MODE_CURRENT        CONTROL_MODE_PD_DIRECTION  // 切换到PD方向环+角速度环

//-------------------------------------------------------------------------------------------------------------------
// 函数简介     检查ADC传感器有效性
// 参数说明     void
// 返回参数     uint8           1-传感器有效 0-传感器无效
// 使用示例     uint8 valid = sensor_check_valid();
// 备注信息     检查传感器是否全黑或全白，判断传感器数据是否可用
//-------------------------------------------------------------------------------------------------------------------
uint8 sensor_check_valid(void);

//-------------------------------------------------------------------------------------------------------------------
// 函数简介     计算位置误差
// 参数说明     void
// 返回参数     float           位置误差(中心为0)
// 使用示例     float err = position_error_calc();
// 备注信息     计算中间传感器相对中心的偏差
//              adc_normalized_list[2]: 0=赛道最左, 25=赛道中心, 50=赛道最右
//              返回值: 负数=偏左, 正数=偏右, 0=居中
//-------------------------------------------------------------------------------------------------------------------
float position_error_calc(void);

//-------------------------------------------------------------------------------------------------------------------
// 函数简介     SDSD控制(带传感器判断)
// 参数说明     void
// 返回参数     float           电机差速修正值
// 使用示例     float correction = sdsd_control_with_sensor_check();
// 备注信息     使用SDSD算法计算偏差，通过PID输出电机差速修正值
//              控制流程: 传感器检查 -> SDSD计算 -> PID控制 -> 异常处理
//-------------------------------------------------------------------------------------------------------------------
float sdsd_control_with_sensor_check(void);

//-------------------------------------------------------------------------------------------------------------------
// 函数简介     PD方向环+角速度环控制(带传感器判断)
// 参数说明     void
// 返回参数     float           电机差速修正值
// 使用示例     float correction = pd_control_with_sensor_check();
// 备注信息     自动检查传感器有效性，传感器异常时使用IMU角速度反馈保持直行
//              控制流程: 传感器检查 -> 位置误差计算 -> PD控制 -> 异常处理
//-------------------------------------------------------------------------------------------------------------------
float pd_control_with_sensor_check(void);

//-------------------------------------------------------------------------------------------------------------------
// 函数简介     电机控制任务(10ms周期调用)
// 参数说明     void
// 返回参数     void
// 使用示例     motor_control_task();
// 备注信息     在10ms定时中断中调用，完成编码器采集和电机控制
//              功能: 编码器采集 -> 控制算法选择 -> 电机输出
//              控制模式由 CONTROL_MODE_CURRENT 宏定义决定
//-------------------------------------------------------------------------------------------------------------------
void motor_control_task(void);

//-------------------------------------------------------------------------------------------------------------------
// 函数简介     IMU更新任务(50ms周期调用)
// 参数说明     void
// 返回参数     void
// 使用示例     imu_update_task();
// 备注信息     在50ms定时中断中调用，更新IMU数据
//              功能: 获取IMU原始数据 -> 四元数解算 -> 欧拉角更新
//-------------------------------------------------------------------------------------------------------------------
void imu_update_task(void);

#endif
