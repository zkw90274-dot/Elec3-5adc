# STC32Gæ™ºèƒ½è½¦é¡¹ç›® - å®Œæ•´æµ‹è¯•æŒ‡å—

> **é¡¹ç›®æ¦‚è¿°ï¼š** åŸºäºSTC32Gå¾®æ§åˆ¶å™¨çš„æ™ºèƒ½å¾ªè¿¹å°è½¦
> **ç¡¬ä»¶å¹³å°ï¼š** STC32G + IMU660RB + 5è·¯ADCä¼ æ„Ÿå™¨ + åŒç¼–ç å™¨ç”µæœº
> **æ ¸å¿ƒç®—æ³•ï¼š** Mahonyå››å…ƒæ•°å§¿æ€è§£ç®— + PDåŒç¯æ§åˆ¶
> **æ–‡æ¡£ç‰ˆæœ¬ï¼š** v2.0
> **æ›´æ–°æ—¥æœŸï¼š** 2026-01-25

---

## ğŸ“‘ ç›®å½•

1. [ä»£ç æ¶æ„è¯´æ˜](#ä»£ç æ¶æ„è¯´æ˜)
2. [æ•°æ®æµå‘å›¾](#æ•°æ®æµå‘å›¾)
3. [æ ¸å¿ƒæ¨¡å—è¯¦è§£](#æ ¸å¿ƒæ¨¡å—è¯¦è§£)
4. [å®Œæ•´æµ‹è¯•æ–¹æ¡ˆ](#å®Œæ•´æµ‹è¯•æ–¹æ¡ˆ)
5. [å‚æ•°è°ƒä¼˜æŒ‡å—](#å‚æ•°è°ƒä¼˜æŒ‡å—)
6. [å¸¸è§é—®é¢˜æ’æŸ¥](#å¸¸è§é—®é¢˜æ’æŸ¥)

---

## ä»£ç æ¶æ„è¯´æ˜

### æ–‡ä»¶ç»“æ„

```
Project/code/
â”œâ”€â”€ ç¡¬ä»¶é©±åŠ¨å±‚ (é©±åŠ¨ç¨‹åº)
â”‚   â”œâ”€â”€ motor.c/h          # ç”µæœºé©±åŠ¨ï¼ˆPWM + æ–¹å‘æ§åˆ¶ï¼‰
â”‚   â”œâ”€â”€ encoder.c/h        # ç¼–ç å™¨ï¼ˆé€Ÿåº¦åé¦ˆ + IIRæ»¤æ³¢ï¼‰
â”‚   â”œâ”€â”€ adc.c/h            # ADCé‡‡é›†ï¼ˆ5è·¯ä¼ æ„Ÿå™¨ + å¤šé‡æ»¤æ³¢ï¼‰
â”‚   â”œâ”€â”€ IMU.c/h            # IMU660RBé©±åŠ¨ + Mahonyå§¿æ€è§£ç®—
â”‚   â”œâ”€â”€ key.c/h            # æŒ‰é”®è¾“å…¥
â”‚   â””â”€â”€ uart.c/h           # ä¸²å£é€šä¿¡
â”‚
â”œâ”€â”€ ç®—æ³•å±‚ (æ§åˆ¶ç®—æ³•)
â”‚   â”œâ”€â”€ quaternion.c/h     # Mahonyå››å…ƒæ•°å§¿æ€è§£ç®—ç®—æ³•
â”‚   â”‚                       â”œâ”€â”€ my_sqrt/asin/atan2 (è‡ªå®šä¹‰æ•°å­¦å‡½æ•°)
â”‚   â”‚                       â”œâ”€â”€ Mahony_Update (å§¿æ€èåˆ)
â”‚   â”‚                       â””â”€â”€ Quaternion_ToEuler (å››å…ƒæ•°è½¬æ¬§æ‹‰è§’)
â”‚   â”œâ”€â”€ pid.c/h            # PID/PDæ§åˆ¶å™¨ï¼ˆé€Ÿåº¦ç¯ + æ–¹å‘ç¯ + è§’é€Ÿåº¦ç¯ï¼‰
â”‚   â”œâ”€â”€ control.c/h        # SDSDç®—æ³•ï¼ˆå·®æ¯”å’Œå·®å¾ªè¿¹ï¼‰
â”‚   â””â”€â”€ normalization.c/h  # å½’ä¸€åŒ–ï¼ˆADCåŸå§‹å€¼ â†’ 0-50æ ‡å‡†å€¼ï¼‰
â”‚
â””â”€â”€ ä»»åŠ¡å±‚ (ä¸»æ§åˆ¶é€»è¾‘)
    â””â”€â”€ task.c/h           # æ§åˆ¶ä»»åŠ¡ç®¡ç†ï¼ˆæ¨¡å¼åˆ‡æ¢ + ä¸»æ§åˆ¶é€»è¾‘ï¼‰
```

### æ§åˆ¶æ¨¡å¼è¯´æ˜

æœ¬é¡¹ç›®æ”¯æŒä¸‰ç§æ§åˆ¶æ¨¡å¼ï¼Œé€šè¿‡ `task.h` ä¸­çš„å®å®šä¹‰åˆ‡æ¢ï¼š

| æ¨¡å¼ç¼–å· | æ¨¡å¼åç§° | æ§åˆ¶ç­–ç•¥ | é€‚ç”¨åœºæ™¯ |
|----------|----------|----------|----------|
| **0** | çº¯PIDé€Ÿåº¦ç¯ | ä»…é€Ÿåº¦é—­ç¯ï¼Œæ— å¾ªè¿¹ | ç”µæœºæµ‹è¯•ã€é€Ÿåº¦æ ¡å‡† |
| **1** | SDSDå¾ªè¿¹ | å·®æ¯”å’Œå·®ç®—æ³• + PID | åŸºç¡€å¾ªè¿¹ã€ç®€å•èµ›é“ |
| **2** | PDæ–¹å‘ç¯+è§’é€Ÿåº¦ç¯ | åŒç¯PDæ§åˆ¶ + Mahonyå§¿æ€ | å¤æ‚èµ›é“ã€é«˜ç²¾åº¦å¾ªè¿¹ |

**æ¨¡å¼åˆ‡æ¢æ–¹æ³•ï¼š**

ä¿®æ”¹ `code/task.h` ç¬¬30è¡Œï¼š
```c
// æ­¥éª¤1: æµ‹è¯•ç”µæœº
#define CONTROL_MODE_CURRENT  CONTROL_MODE_PID_ONLY

// æ­¥éª¤2: SDSDå¾ªè¿¹
// #define CONTROL_MODE_CURRENT  CONTROL_MODE_SDSD

// æ­¥éª¤3: PDæ–¹å‘ç¯+è§’é€Ÿåº¦ç¯
// #define CONTROL_MODE_CURRENT  CONTROL_MODE_PD_DIRECTION
```

---

## æ•°æ®æµå‘å›¾

### å®Œæ•´æ§åˆ¶æµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ã€ä¼ æ„Ÿå™¨é‡‡é›†å±‚ã€‘ - å®šæ—¶ä¸­æ–­è§¦å‘                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  TIM1 (10ms) â†’ ç”µæœºæ§åˆ¶ + ç¼–ç å™¨é‡‡é›†                        â”‚
â”‚  TIM2 (10ms) â†’ IMUæ•°æ®æ›´æ–° (100Hz)                          â”‚
â”‚                                                             â”‚
â”‚  â€¢ 5è·¯ADCä¼ æ„Ÿå™¨      â†’ Adc_Getval_Fast()  â†’ adc_val_list[5] â”‚
â”‚  â€¢ ç¼–ç å™¨(L/R)       â†’ Encoder_Get_Filtered() â†’ encoder_*  â”‚
â”‚  â€¢ IMU660RB (10ms)  â†’ imu_update_task()   â†’ imu æ•°æ®       â”‚
â”‚                        â†“                                  â”‚
â”‚                      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                   â”‚
â”‚                      â”‚ IMUæ•°æ®é‡‡é›†      â”‚                   â”‚
â”‚                      â”‚ - acc_x/y/z     â”‚                   â”‚
â”‚                      â”‚ - gyro_x/y/z    â”‚                   â”‚
â”‚                      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ã€IMUå§¿æ€è§£ç®—å±‚ã€‘ - Mahonyå››å…ƒæ•°ç®—æ³• (10mså‘¨æœŸ)             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚  IMUåŸå§‹æ•°æ® â†’ imu_get_data() â†’ imu.acc/gyro åŸå§‹å€¼        â”‚
â”‚       â†“                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚  â”‚  Mahonyå§¿æ€èåˆç®—æ³•                             â”‚        â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚        â”‚
â”‚  â”‚  â”‚ 1. åŠ é€Ÿåº¦è®¡å½’ä¸€åŒ–                        â”‚    â”‚        â”‚
â”‚  â”‚  â”‚    ax, ay, az (å•ä½g)                   â”‚    â”‚        â”‚
â”‚  â”‚  â”‚                                         â”‚    â”‚        â”‚
â”‚  â”‚  â”‚ 2. é™€èºä»ªè½¬å¼§åº¦                          â”‚    â”‚        â”‚
â”‚  â”‚  â”‚    gx, gy, gz (rad/s)                   â”‚    â”‚        â”‚
â”‚  â”‚  â”‚                                         â”‚    â”‚        â”‚
â”‚  â”‚  â”‚ 3. PIæ§åˆ¶å™¨ä¿®æ­£é™€èºä»ªæ¼‚ç§»                â”‚    â”‚        â”‚
â”‚  â”‚  â”‚    Kp=0.3, Ki=0.002                     â”‚    â”‚        â”‚
â”‚  â”‚  â”‚                                         â”‚    â”‚        â”‚
â”‚  â”‚  â”‚ 4. å››å…ƒæ•°å¾®åˆ†æ–¹ç¨‹æ›´æ–°                    â”‚    â”‚        â”‚
â”‚  â”‚  â”‚    q0, q1, q2, q3                       â”‚    â”‚        â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚        â”‚
â”‚  â”‚                      â†“                          â”‚        â”‚
â”‚  â”‚  å››å…ƒæ•°è¾“å‡º (q0, q1, q2, q3)                  â”‚        â”‚
â”‚  â”‚  æ¨¡é•¿çº¦æŸ: q0Â²+q1Â²+q2Â²+q3Â² = 1                â”‚        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â”‚                      â†“                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚  â”‚  å››å…ƒæ•°è½¬æ¬§æ‹‰è§’                                 â”‚        â”‚
â”‚  â”‚  q0,q1,q2,q3 â†’ roll, pitch, yaw (è§’åº¦)         â”‚        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â”‚                                                             â”‚
â”‚  è¾“å‡ºæ•°æ®ï¼š                                                  â”‚
â”‚  â€¢ imu.q0, q1, q2, q3    (å››å…ƒæ•°)                          â”‚
â”‚  â€¢ imu.roll, pitch, yaw   (æ¬§æ‹‰è§’ï¼Œå•ä½Â°)                   â”‚
â”‚  â€¢ imu.gyro_z             (è§’é€Ÿåº¦ï¼ŒÂ°/sï¼Œç”¨äºé—­ç¯)            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ã€æ•°æ®é¢„å¤„ç†å±‚ã€‘                                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ADCåŸå§‹å€¼ â†’ Normalization() â†’ adc_normalized_list[5]       â”‚
â”‚              å½’ä¸€åŒ–èŒƒå›´: 0-50                                â”‚
â”‚              â€¢ 0 = æœ€ç™½ï¼ˆèµ›é“çº¿å¤–ï¼‰                          â”‚
â”‚              â€¢ 25 = ä¸­é—´ï¼ˆèµ›é“è¾¹ç•Œï¼‰                         â”‚
â”‚              â€¢ 50 = æœ€é»‘ï¼ˆèµ›é“ä¸­å¿ƒçº¿ï¼‰                       â”‚
â”‚                                                             â”‚
â”‚  ç¼–ç å™¨åŸå§‹å€¼ â†’ IIRä½é€šæ»¤æ³¢(Î±=0.2) â†’ å¹³æ»‘é€Ÿåº¦å€¼             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ã€æ§åˆ¶ç®—æ³•å±‚ã€‘ - motor_control_task() (10mså‘¨æœŸ)           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  1. ä¼ æ„Ÿå™¨æœ‰æ•ˆæ€§æ£€æŸ¥ (sensor_check_valid)                   â”‚
â”‚     â†’ å…¨é»‘æ£€æµ‹: ä¼ æ„Ÿå™¨1,2,3 > 48 (è„±ç¦»èµ›é“)                 â”‚
â”‚     â†’ å…¨ç™½æ£€æµ‹: ä¼ æ„Ÿå™¨1,2,3 < 2 (èµ·é£/æ•…éšœ)                 â”‚
â”‚                                                             â”‚
â”‚  2. æ ¹æ®æ¨¡å¼é€‰æ‹©æ§åˆ¶ç®—æ³•                                     â”‚
â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚
â”‚     â”‚ æ¨¡å¼0: pid_only_control()               â”‚             â”‚
â”‚     â”‚   â†’ è¿”å› 0 (æ— ä¿®æ­£ï¼Œä»…é€Ÿåº¦ç¯)            â”‚             â”‚
â”‚     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤             â”‚
â”‚     â”‚ æ¨¡å¼1: sdsd_control_with_sensor_check() â”‚             â”‚
â”‚     â”‚   â†’ SDSD_calculate() (å·®æ¯”å’Œå·®)         â”‚             â”‚
â”‚     â”‚   â†’ pid_calc_position() (PIDæ§åˆ¶)       â”‚             â”‚
â”‚     â”‚   â†’ å¼‚å¸¸æ—¶ä¿æŒä¸Šæ¬¡è¾“å‡º                   â”‚             â”‚
â”‚     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤             â”‚
â”‚     â”‚ æ¨¡å¼2: pd_control_with_sensor_check()   â”‚             â”‚
â”‚     â”‚   â†’ position_error_calc() (ä½ç½®è¯¯å·®)    â”‚             â”‚
â”‚     â”‚   â†’ pd_direction_gyro_loop() (åŒç¯PD)    â”‚             â”‚
â”‚     â”‚   â†’ å¼‚å¸¸æ—¶ä½¿ç”¨IMUè§’é€Ÿåº¦åé¦ˆ              â”‚             â”‚
â”‚     â”‚     imu.gyro_z åŸå§‹å€¼ç”¨äºé—­ç¯            â”‚             â”‚
â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚
â”‚                                                             â”‚
â”‚  3. ç”µæœºé€Ÿåº¦ç¯PIDæ§åˆ¶                                       â”‚
â”‚     â†’ motor_pid_control(encoder_L + correction,             â”‚
â”‚                             encoder_R - correction)         â”‚
â”‚     â†’ å¢é‡å¼PIDè®¡ç®— â†’ PWMè¾“å‡º                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## æ ¸å¿ƒæ¨¡å—è¯¦è§£

### 1ï¸âƒ£ Mahonyå››å…ƒæ•°å§¿æ€è§£ç®—

**æ–‡ä»¶ä½ç½®ï¼š** `code/quaternion.c`

**ç®—æ³•è¯´æ˜ï¼š**

Mahonyç®—æ³•æ˜¯ä¸€ç§äº’è¡¥æ»¤æ³¢ç®—æ³•ï¼Œç”¨äºèåˆåŠ é€Ÿåº¦è®¡å’Œé™€èºä»ªæ•°æ®ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Mahonyå§¿æ€è§£ç®—æµç¨‹                                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                          â”‚
â”‚  åŠ é€Ÿåº¦è®¡ â”€â”€â”                                           â”‚
â”‚  (ax,ay,az) â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                        â”‚
â”‚            â””â”€â”€â”€â†’â”‚ å½’ä¸€åŒ–åˆ°å•ä½å‘é‡â”‚                        â”‚
â”‚                 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                        â”‚
â”‚                      â†“                                  â”‚
â”‚  é™€èºä»ª â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’â”                          â”‚
â”‚  (gx,gy,gz)                  â†“                          â”‚
â”‚                     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                    â”‚
â”‚                     â”‚ PIæ§åˆ¶å™¨ä¿®æ­£ â”‚                    â”‚
â”‚                     â”‚ Kp=0.3      â”‚                    â”‚
â”‚                     â”‚ Ki=0.002    â”‚                    â”‚
â”‚                     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                    â”‚
â”‚                      â†“                                  â”‚
â”‚              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                        â”‚
â”‚              â”‚ å››å…ƒæ•°æ›´æ–°       â”‚                        â”‚
â”‚              â”‚ q0,q1,q2,q3    â”‚                        â”‚
â”‚              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                        â”‚
â”‚                      â†“                                  â”‚
â”‚              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                        â”‚
â”‚              â”‚ å½’ä¸€åŒ–(æ¨¡é•¿=1)  â”‚                        â”‚
â”‚              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                        â”‚
â”‚                      â†“                                  â”‚
â”‚          è¾“å‡º: å››å…ƒæ•° + æ¬§æ‹‰è§’                              â”‚
â”‚                                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**æ•°æ®æ¥å£ï¼š**

```c
// IMUåŸå§‹æ•°æ®ï¼ˆ10msæ›´æ–°ï¼‰
struct IMUData imu;
imu.acc_x, imu.acc_y, imu.acc_z    // åŠ é€Ÿåº¦è®¡ (g)
imu.gyro_x, imu.gyro_y, imu.gyro_z  // é™€èºä»ª (Â°/s)

// å››å…ƒæ•°è¾“å‡º
imu.q0, imu.q1, imu.q2, imu.q3      // å››å…ƒæ•° (æ¨¡é•¿=1)

// æ¬§æ‹‰è§’è¾“å‡ºï¼ˆç”¨äºå¯¼èˆªï¼‰
imu.roll, imu.pitch, imu.yaw        // æ¬§æ‹‰è§’ (Â°)

// è§’é€Ÿåº¦ï¼ˆç”¨äºé—­ç¯æ§åˆ¶ï¼‰
imu.gyro_z                          // åŸå§‹è§’é€Ÿåº¦ (Â°/s)
```

**å‚æ•°è¯´æ˜ï¼š**

| å‚æ•° | ä½ç½® | æ¨èå€¼ | ä½œç”¨ |
|------|------|--------|------|
| **MAHONY_KP** | quaternion.h:8 | 0.3 | æ¯”ä¾‹å¢ç›Šï¼Œæ§åˆ¶å“åº”é€Ÿåº¦ |
| **MAHONY_KI** | quaternion.h:9 | 0.002 | ç§¯åˆ†å¢ç›Šï¼Œæ¶ˆé™¤é™€èºä»ªæ¼‚ç§» |

**è°ƒå‚è§„åˆ™ï¼š**
- **å“åº”æ…¢/æŠ–åŠ¨ï¼š** å¢å¤§ MAHONY_KP (0.4-0.5)
- **æœ‰æ¼‚ç§»ï¼š** å¢å¤§ MAHONY_KI (0.003-0.005)
- **æŠ—å¹²æ‰°å·®ï¼š** å‡å° MAHONY_KI (0.001-0.0015)

---

### 2ï¸âƒ£ motor_control_task() - ä¸»æ§åˆ¶ä»»åŠ¡

**æ–‡ä»¶ä½ç½®ï¼š** `code/task.c:186-223`

**è°ƒç”¨å‘¨æœŸï¼š** 10mså®šæ—¶å™¨ä¸­æ–­

**åŠŸèƒ½è¯´æ˜ï¼š**
```c
void motor_control_task(void)
{
    // æ­¥éª¤1: è·å–æ»¤æ³¢åçš„ç¼–ç å™¨å€¼
    Encoder_Get_Filtered();

    // æ­¥éª¤2: æ ¹æ®æ¨¡å¼é€‰æ‹©æ§åˆ¶ç®—æ³•
    mode = get_control_mode();
    switch(mode) {
        case 0: correction = pid_only_control();      // è¿”å›0
        case 1: correction = sdsd_control_with_sensor_check();
        case 2: correction = pd_control_with_sensor_check();
    }

    // æ­¥éª¤3: ç”µæœºé€Ÿåº¦ç¯PIDæ§åˆ¶
    motor_pid_control(encoder_data_dir_L + correction,
                      encoder_data_dir_R - correction);
}
```

**å…³é”®ç‚¹ï¼š**
- å·¦è½®å åŠ ä¿®æ­£å€¼ï¼š`encoder_L + correction`
- å³è½®å‡å»ä¿®æ­£å€¼ï¼š`encoder_R - correction`
- correctionä¸ºæ­£ â†’ å³è½¬ï¼ˆå·¦è½®åŠ é€Ÿï¼Œå³è½®å‡é€Ÿï¼‰
- correctionä¸ºè´Ÿ â†’ å·¦è½¬ï¼ˆå·¦è½®å‡é€Ÿï¼Œå³è½®åŠ é€Ÿï¼‰

---

### 3ï¸âƒ£ PDæ–¹å‘ç¯+è§’é€Ÿåº¦ç¯ - åŒç¯æ§åˆ¶

**æ–‡ä»¶ä½ç½®ï¼š** `code/pid.c:347-394`

**æ§åˆ¶ç»“æ„ï¼š**
```
ä½ç½®è¯¯å·® â†’ PDæ–¹å‘ç¯ â†’ æœŸæœ›è§’é€Ÿåº¦ â†’ PDè§’é€Ÿåº¦ç¯ â†’ ç”µæœºä¿®æ­£å€¼
   â†‘                                                â†“
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ IMUè§’é€Ÿåº¦åé¦ˆ â†â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         imu.gyro_z (åŸå§‹å€¼ï¼ŒéMahonyä¿®æ­£)
```

**ä»£ç å®ç°ï¼š**
```c
float pd_direction_gyro_loop(float err_position)
{
    // ç¬¬ä¸€çº§ï¼šPDæ–¹å‘ç¯ï¼ˆä½ç½®è¯¯å·® â†’ æœŸæœ›è§’é€Ÿåº¦ï¼‰
    expect_gyro = pd_direction.kp * err_position +
                  pd_direction.kd * (err_position - last_err_position);
    expect_gyro = constrain(expect_gyro, -100, 100);

    // ç¬¬äºŒçº§ï¼šPDè§’é€Ÿåº¦ç¯ï¼ˆè§’é€Ÿåº¦è¯¯å·® â†’ ç”µæœºä¿®æ­£ï¼‰
    err_gyro = expect_gyro - imu.gyro_z;  // ä½¿ç”¨åŸå§‹è§’é€Ÿåº¦
    correction = pd_direction.kp_gyro * err_gyro +
                 pd_direction.kd_gyro * (err_gyro - last_err_gyro);
    correction = constrain(correction, -100, 100);

    return correction;
}
```

**å…³é”®ç‚¹ï¼š**
- `imu.gyro_z` æ˜¯åŸå§‹ä¼ æ„Ÿå™¨æ•°æ®ï¼Œä¸å—Mahonyç®—æ³•å½±å“
- Mahonyç®—æ³•åªæä¾›å§¿æ€åŸºå‡†ï¼ˆyawè§’ï¼‰ç”¨äºå¯¼èˆª
- è§’é€Ÿåº¦é—­ç¯ä½¿ç”¨åŸå§‹æ•°æ®ï¼Œå“åº”å¿«é€Ÿ

---

## å®Œæ•´æµ‹è¯•æ–¹æ¡ˆ

### âš ï¸ æµ‹è¯•å‰å‡†å¤‡

#### ç¡¬ä»¶æ£€æŸ¥æ¸…å•
- [ ] ç”µæœºé©±åŠ¨è¿æ¥æ­£ç¡®ï¼ˆå·¦å³ç”µæœºæ–¹å‘æ­£ç¡®ï¼‰
- [ ] ç¼–ç å™¨è¿æ¥æ­£ç¡®ï¼ˆA/Bç›¸ä¸æ¥åï¼‰
- [ ] 5è·¯ADCä¼ æ„Ÿå™¨å®‰è£…ä½ç½®æ­£ç¡®ï¼ˆä»å·¦åˆ°å³ï¼š0-4ï¼‰
- [ ] IMU660RBå®‰è£…ç¨³å›ºï¼Œæ–¹å‘æ­£ç¡®ï¼ˆXå‘å‰ï¼ŒYå‘å·¦ï¼ŒZå‘ä¸Šï¼‰
- [ ] ç”µæºä¾›ç”µç¨³å®šï¼ˆå»ºè®®7.4Vé”‚ç”µæ± ï¼‰

#### ç¼–è¯‘é…ç½®
- **èŠ¯ç‰‡å‹å·ï¼š** STC32G12K128
- **æ—¶é’Ÿé¢‘ç‡ï¼š** 30MHz
- **ç¼–è¯‘å™¨ï¼š** C251ï¼ˆKeilï¼‰

---

### é˜¶æ®µ1ï¸âƒ£: æ­¥éª¤1 - é€Ÿåº¦ç¯PIDè°ƒè¯•

#### æµ‹è¯•ç›®çš„
éªŒè¯é€Ÿåº¦ç¯PIDå·¥ä½œæ­£å¸¸ï¼Œå·¦å³è½®é€Ÿåº¦ä¸€è‡´

#### é…ç½®æ–¹æ³•
ä¿®æ”¹ `code/task.h:30`ï¼š
```c
#define CONTROL_MODE_CURRENT  CONTROL_MODE_PID_ONLY
```

#### æµ‹è¯•æ­¥éª¤

**Step 1: ç¼–è¯‘ä¸‹è½½ç¨‹åº**
1. ç¼–è¯‘é¡¹ç›®ï¼ˆç¡®ä¿æ— é”™è¯¯ï¼‰
2. ä¸‹è½½åˆ°STC32G
3. æ‰“å¼€ä¸²å£ç›‘è§†å™¨ï¼ˆæ³¢ç‰¹ç‡115200ï¼‰

**Step 2: è§‚å¯Ÿä¸²å£è¾“å‡º**
```
IMU init success!
Quaternion: q0=1.000, q1=0.000, q2=0.000, q3=0.000
Euler: Roll=0.50, Pitch=-1.20, Yaw=0.00
Encoder: R=30, L=29
```

**æœŸæœ›ç»“æœï¼š**
- ç¼–ç å™¨å€¼ç¨³å®šåœ¨ç›®æ ‡å€¼é™„è¿‘ï¼ˆé»˜è®¤30ï¼‰
- å·¦å³è½®è¯¯å·®åœ¨Â±5ä»¥å†…
- è½¦è½®å¹³ç¨³è½¬åŠ¨ï¼Œæ— æŠ–åŠ¨
- å››å…ƒæ•°æ¨¡é•¿æ¥è¿‘1.0

**Step 3: è°ƒæ•´ç›®æ ‡é€Ÿåº¦**

ä¿®æ”¹ `user/main.c:89-90`ï¼š
```c
pid_set_target(&pid_motor_left, 50.0f);   // å¢å¤§ç›®æ ‡é€Ÿåº¦
pid_set_target(&pid_motor_right, 50.0f);
```

**ç›®æ ‡é€Ÿåº¦å‚è€ƒï¼š**
| é€Ÿåº¦å€¼ | è½¦é€Ÿ | é€‚ç”¨åœºæ™¯ |
|--------|------|----------|
| 20-30 | æ…¢é€Ÿ | æµ‹è¯•/è°ƒè¯• |
| 40-60 | ä¸­é€Ÿ | æ™®é€šå¾ªè¿¹ |
| 70-100 | å¿«é€Ÿ | ç«é€Ÿæ¨¡å¼ |

#### æˆåŠŸæ ‡å¿—
- âœ… å·¦å³è½®ä»¥ç›¸åŒé€Ÿåº¦ç¨³å®šè½¬åŠ¨
- âœ… ç¼–ç å™¨åé¦ˆå€¼æ¥è¿‘ç›®æ ‡å€¼ï¼ˆè¯¯å·®<10%ï¼‰
- âœ… æ— æ˜æ˜¾æŠ–åŠ¨æˆ–å¼‚å“
- âœ… åŠ å‡é€Ÿå¹³æ»‘

---

### é˜¶æ®µ2ï¸âƒ£: æ­¥éª¤2 - SDSDç”µç£å¾ªè¿¹

#### æµ‹è¯•ç›®çš„
éªŒè¯SDSDç®—æ³•å’Œä¼ æ„Ÿå™¨æœ‰æ•ˆæ€§æ£€æŸ¥

#### é…ç½®æ–¹æ³•
ä¿®æ”¹ `code/task.h:31`ï¼ˆæ³¨é‡Šç¬¬30è¡Œï¼Œå–æ¶ˆç¬¬31è¡Œæ³¨é‡Šï¼‰ï¼š
```c
// #define CONTROL_MODE_CURRENT  CONTROL_MODE_PID_ONLY
#define CONTROL_MODE_CURRENT  CONTROL_MODE_SDSD
```

#### æµ‹è¯•æ­¥éª¤

**Step 1: é™æ€æµ‹è¯•ï¼ˆå°è½¦ä¿æŒä¸åŠ¨ï¼‰**

å°†å°è½¦æ”¾åœ¨èµ›é“ä¸åŒä½ç½®ï¼Œè§‚å¯Ÿä¸²å£è¾“å‡ºï¼š

**æœŸæœ›ç»“æœï¼š**
| å°è½¦ä½ç½® | ä¼ æ„Ÿå™¨å€¼(ç¤ºä¾‹) | SDSDè¾“å‡º | ä¿®æ­£æ–¹å‘ |
|----------|----------------|----------|----------|
| å±…ä¸­ | 5 8 48 10 6 | æ¥è¿‘0 | æ— ä¿®æ­£ |
| åå·¦ | 25 48 45 5 3 | è´Ÿæ•°(-20~-50) | å³è½¬ |
| åå³ | 3 5 47 46 24 | æ­£æ•°(+20~+50) | å·¦è½¬ |

**Step 2: åŠ¨æ€å¾ªè¿¹æµ‹è¯•**

å°†å°è½¦æ”¾åœ¨èµ›é“èµ·ç‚¹ï¼Œè®©å…¶è‡ªåŠ¨å¾ªè¿¹

**åˆå§‹å‚æ•°ï¼š** `user/main.c:79-81`
```c
SDSD_init(&SDSD, 1.0f, 1.0f, 1.0f);        // A=B=C=1.0
pid_init(&pid_SDSD, 2.0f, 0.0f, 0.5f);     // Kp=2.0, Ki=0, Kd=0.5
```

**æµ‹è¯•ç°è±¡è®°å½•è¡¨ï¼š**

| ç°è±¡ | å¯èƒ½åŸå›  | è°ƒæ•´æ–¹æ¡ˆ |
|------|----------|----------|
| å¾ªè¿¹æ­£å¸¸ | å‚æ•°åˆé€‚ | æ— éœ€è°ƒæ•´ âœ… |
| å“åº”å¤ªæ…¢ | SDSDç³»æ•°è¿‡å° | å¢å¤§A,B |
| è½¬å¼¯ä¸è¶³ | Kpè¿‡å° | å¢å¤§Kpåˆ°2.5-3.0 |
| éœ‡è¡/è¶…è°ƒ | Kpæˆ–Kdè¿‡å¤§ | å‡å°Kpåˆ°1.5, Kdåˆ°0.3 |
| ç›´çº¿æŠ–åŠ¨ | Kdè¿‡å¤§ | å‡å°Kdåˆ°0.2 |

#### æˆåŠŸæ ‡å¿—
- âœ… å°è½¦èƒ½ç¨³å®šæ²¿èµ›é“ä¸­å¿ƒçº¿è¡Œé©¶
- âœ… è½¬å¼¯æ—¶å¹³æ»‘è¿‡æ¸¡ï¼Œæ— å‰§çƒˆéœ‡è¡
- âœ… ç›´çº¿æ®µæ— æ˜æ˜¾æŠ–åŠ¨
- âœ… èƒ½å®Œæˆå®Œæ•´èµ›é“å¾ªè¿¹

---

### é˜¶æ®µ3ï¸âƒ£: æ­¥éª¤3 - IMUæ•°æ®éªŒè¯ä¸è°ƒè¯•

#### æµ‹è¯•ç›®çš„
éªŒè¯Mahonyå››å…ƒæ•°ç®—æ³•è¾“å‡ºæ­£ç¡®

#### é…ç½®æ–¹æ³•
ä¿æŒå½“å‰æ¨¡å¼ï¼ˆä»»ä½•æ¨¡å¼éƒ½å¯ä»¥è§‚å¯ŸIMUæ•°æ®ï¼‰

#### æµ‹è¯•æ­¥éª¤

**Step 1: éªŒè¯å››å…ƒæ•°æ•°æ®**

ä¸²å£è¾“å‡ºå·²åŒ…å«å››å…ƒæ•°æ•°æ®ï¼š
```
Quaternion: q0=1.000, q1=0.000, q2=0.000, q3=0.000
Euler: Roll=0.50, Pitch=-1.20, Yaw=45.30
```

**é™æ­¢æ°´å¹³æ—¶éªŒè¯ï¼š**
- q0 â‰ˆ 1.0, q1/q2/q3 â‰ˆ 0.0
- Roll â‰ˆ 0Â°, Pitch â‰ˆ 0Â°
- å››å…ƒæ•°æ¨¡é•¿ï¼šq0Â² + q1Â² + q2Â² + q3Â² â‰ˆ 1.0

**æ—‹è½¬æ—¶éªŒè¯ï¼š**
| æ“ä½œ | æœŸæœ›å˜åŒ– |
|------|----------|
| å‘å·¦è½¬90Â° | Yawå‡å°çº¦90Â° |
| å‘å³è½¬90Â° | Yawå¢å¤§çº¦90Â° |
| å‰å€¾ | Pitchå¢å¤§ |
| åå€¾ | Pitchå‡å° |
| å·¦å€¾ | Rollå¢å¤§ |
| å³å€¾ | Rollå‡å° |

**Step 2: éªŒè¯è§’é€Ÿåº¦æ•°æ®**

```c
// å½“å‰è§’é€Ÿåº¦é—­ç¯ä½¿ç”¨çš„æ•°æ®
printf("GyroZ: %.2f\r\n", imu.gyro_z);
```

| æ“ä½œ | æœŸæœ›è¾“å‡º |
|------|----------|
| æ°´å¹³é™æ­¢ | GyroZ â‰ˆ 0 |
| å‘å·¦æ—‹è½¬ | GyroZ è´Ÿå€¼ï¼ˆ-10~-50Â°/sï¼‰ |
| å‘å³æ—‹è½¬ | GyroZ æ­£å€¼ï¼ˆ+10~+50Â°/sï¼‰ |

**Step 3: Mahonyå‚æ•°è°ƒæ•´**

å¦‚å‘ç°å“åº”æ…¢æˆ–æ¼‚ç§»å¤§ï¼Œè°ƒæ•´ `code/quaternion.h:8-9`ï¼š

```c
// å¦‚æœå“åº”æ…¢/æŠ–åŠ¨
#define MAHONY_KP  0.4f  // å¢å¤§

// å¦‚æœæœ‰æ˜æ˜¾æ¼‚ç§»
#define MAHONY_KI  0.003f  // å¢å¤§

// å¦‚æœæŠ—å¹²æ‰°å·®
#define MAHONY_KP  0.2f  // å‡å°
#define MAHONY_KI  0.001f // å‡å°
```

#### æˆåŠŸæ ‡å¿—
- âœ… å››å…ƒæ•°æ¨¡é•¿æ’å®šä¸º1.0
- âœ… é™æ­¢æ—¶æ¬§æ‹‰è§’ç¨³å®š
- âœ… æ—‹è½¬åyawè§’å‡†ç¡®ï¼ˆè¯¯å·®<5Â°ï¼‰
- âœ… é•¿æ—¶é—´è¿è¡Œæ— ç´¯ç§¯æ¼‚ç§»

---

### é˜¶æ®µ4ï¸âƒ£: æ­¥éª¤4 - PDæ–¹å‘ç¯+è§’é€Ÿåº¦ç¯å¾ªè¿¹

#### æµ‹è¯•ç›®çš„
éªŒè¯IMUæ•°æ®å’ŒåŒç¯PDæ§åˆ¶

#### é…ç½®æ–¹æ³•
ä¿®æ”¹ `code/task.h:32`ï¼š
```c
#define CONTROL_MODE_CURRENT  CONTROL_MODE_PD_DIRECTION
```

#### æµ‹è¯•æ­¥éª¤

**Step 1: é™æ€æµ‹è¯•ï¼ˆå°è½¦ä¿æŒä¸åŠ¨ï¼‰**

å°†å°è½¦æ”¾åœ¨èµ›é“ä¸åŒä½ç½®ï¼Œè§‚å¯Ÿä¿®æ­£å€¼ï¼š

**æœŸæœ›ç»“æœï¼š**
| å°è½¦ä½ç½® | ä½ç½®è¯¯å·® | æœŸæœ›è§’é€Ÿåº¦ | å®é™…è¡Œä¸º |
|----------|----------|------------|----------|
| å±…ä¸­ | 0 | 0 | ä¿æŒç›´è¡Œ |
| åå·¦ | è´Ÿæ•°(-20) | æ­£è§’é€Ÿåº¦(+40Â°/s) | å³è½¬ä¿®æ­£ |
| åå³ | æ­£æ•°(+20) | è´Ÿè§’é€Ÿåº¦(-40Â°/s) | å·¦è½¬ä¿®æ­£ |

**Step 2: åŠ¨æ€æµ‹è¯•**

**åˆå§‹å‚æ•°ï¼š** `user/main.c:94`
```c
pd_init(&pd_direction, 2.5f, 0.8f, 1.2f, 0.3f);
// æ–¹å‘ç¯: Kp=2.5, Kd=0.8
// è§’é€Ÿåº¦ç¯: Kp_gyro=1.2, Kd_gyro=0.3
```

**è°ƒå‚é¡ºåºï¼ˆå…ˆå†…ç¯åå¤–ç¯ï¼‰ï¼š**

**Step 2.1: è°ƒæ•´è§’é€Ÿåº¦ç¯ï¼ˆå†…ç¯ï¼‰**
```c
// æµ‹è¯•æ–¹æ³•ï¼šæ‰‹åŠ¨æ—‹è½¬å°è½¦åæ¾æ‰‹ï¼Œè§‚å¯Ÿæ¢å¤é€Ÿåº¦

// å¦‚æœæ¢å¤å¤ªæ…¢
pd_init(&pd_direction, 2.5f, 0.8f, 2.0f, 0.5f);  // å¢å¤§kp_gyro, kd_gyro

// å¦‚æœéœ‡è¡
pd_init(&pd_direction, 2.5f, 0.8f, 0.8f, 0.2f);  // å‡å°kp_gyro, kd_gyro
```

**Step 2.2: è°ƒæ•´æ–¹å‘ç¯ï¼ˆå¤–ç¯ï¼‰**
```c
// å¦‚æœå¾ªè¿¹å“åº”æ…¢
pd_init(&pd_direction, 3.5f, 1.2f, 1.2f, 0.3f);  // å¢å¤§Kp, Kd

// å¦‚æœæŠ–åŠ¨
pd_init(&pd_direction, 2.0f, 0.5f, 1.2f, 0.3f);  // å‡å°Kp, Kd
```

#### æµ‹è¯•ç°è±¡è®°å½•è¡¨

| ç°è±¡ | å¯èƒ½åŸå›  | è°ƒæ•´æ–¹æ¡ˆ |
|------|----------|----------|
| å¾ªè¿¹æ­£å¸¸ | å‚æ•°åˆé€‚ | æ— éœ€è°ƒæ•´ âœ… |
| è½¬å¼¯å“åº”æ…¢ | Kpæˆ–kp_gyroè¿‡å° | å¢å¤§Kpæˆ–kp_gyro |
| éœ‡è¡/æŠ–åŠ¨ | Kdæˆ–kd_gyroè¿‡å¤§ | å‡å°Kdæˆ–kd_gyro |
| æ— æ³•ä¿æŒç›´è¡Œ | IMUæ•°æ®å¼‚å¸¸ | æ£€æŸ¥IMUåˆå§‹åŒ– |
| è½¬å¼¯è¿‡åº¦ | Kpè¿‡å¤§ | å‡å°Kp |

#### æˆåŠŸæ ‡å¿—
- âœ… å°è½¦å¾ªè¿¹ç¨³å®šï¼Œå“åº”å¿«é€Ÿ
- âœ… è½¬å¼¯å¹³æ»‘ï¼Œæ— è¶…è°ƒ
- âœ… IMUè§’é€Ÿåº¦é—­ç¯æœ‰æ•ˆå·¥ä½œ
- âœ… èƒ½å®Œæˆå¤æ‚èµ›é“å¾ªè¿¹

---

## å‚æ•°è°ƒä¼˜æŒ‡å—

### ç”µæœºé€Ÿåº¦ç¯PID

**ä½ç½®ï¼š** `user/main.c:84-85`

**åˆå§‹å‚æ•°ï¼š**
```c
pid_init(&pid_motor_left, 1.7f, 0.22f, 0.2f);
pid_init(&pid_motor_right, 1.7f, 0.1f, 0.0f);
```

**è°ƒå‚è§„åˆ™ï¼š**

| ç°è±¡ | è°ƒæ•´Kp | è°ƒæ•´Ki | è°ƒæ•´Kd |
|------|--------|--------|--------|
| å“åº”æ…¢ | å¢å¤§ | å¢å¤§ | - |
| é€Ÿåº¦æŠ–åŠ¨ | å‡å° | - | å¢å¤§ |
| ç¨³æ€è¯¯å·®å¤§ | - | å¢å¤§ | - |
| è¶…è°ƒä¸¥é‡ | å‡å° | å‡å° | å¢å¤§ |

**æ¨èèŒƒå›´ï¼š**
- **Kp:** 1.0-3.0
- **Ki:** 0.1-0.5
- **Kd:** 0.0-0.5

---

### SDSDç³»æ•°

**ä½ç½®ï¼š** `user/main.c:79`

**åˆå§‹å‚æ•°ï¼š**
```c
SDSD_init(&SDSD, 1.0f, 1.0f, 1.0f);
```

**å‚æ•°å«ä¹‰ï¼š**
| å‚æ•° | ä½œç”¨ä¼ æ„Ÿå™¨ | æ¨èèŒƒå›´ | è¯´æ˜ |
|------|------------|----------|------|
| **A** | å¤–å±‚(0,4) | 0.5-1.5 | æ§åˆ¶è¾¹ç¼˜ä¼ æ„Ÿå™¨å½±å“ |
| **B** | å†…å±‚(1,3) | 0.5-1.5 | æ§åˆ¶è¿‘ä¸­å¿ƒä¼ æ„Ÿå™¨å½±å“ |
| **C** | ä¸­å¿ƒ(2) | 0.5-1.5 | æ§åˆ¶å½’ä¸€åŒ–æƒé‡ |

**è°ƒå‚è§„åˆ™ï¼š**
- **å¢å¤§Aã€Bï¼š** æé«˜å“åº”é€Ÿåº¦ï¼Œä½†å¯èƒ½å¼•èµ·éœ‡è¡
- **å¢å¤§Cï¼š** æé«˜ç›´çº¿ç¨³å®šæ€§ï¼Œä½†å“åº”å˜æ…¢
- **æ¨èé¡ºåºï¼š** å…ˆè°ƒA=B=C=1.0ï¼Œå†æ ¹æ®è¡¨ç°å¾®è°ƒ

---

### SDSDçš„PID

**ä½ç½®ï¼š** `user/main.c:80`

**åˆå§‹å‚æ•°ï¼š**
```c
pid_init(&pid_SDSD, 2.0f, 0.0f, 0.5f);
```

**è°ƒå‚è§„åˆ™ï¼š**

| ç°è±¡ | è°ƒæ•´Kp | è°ƒæ•´Ki | è°ƒæ•´Kd |
|------|--------|--------|--------|
| è½¬å¼¯ä¸è¶³ | å¢å¤§(2.5-3.5) | - | - |
| éœ‡è¡/è¶…è°ƒ | å‡å°(1.0-1.5) | - | - |
| ç›´çº¿æŠ–åŠ¨ | - | - | å‡å°(0.2-0.3) |
| å“åº”æ…¢ | å¢å¤§ | - | å¢å¤§ |

**æ¨èèŒƒå›´ï¼š**
- **Kp:** 1.5-3.5
- **Ki:** 0ï¼ˆé€šå¸¸ä¸éœ€è¦ç§¯åˆ†ï¼‰
- **Kd:** 0.2-0.8

---

### Mahonyå§¿æ€è§£ç®—å‚æ•°

**ä½ç½®ï¼š** `code/quaternion.h:8-9`

**åˆå§‹å‚æ•°ï¼š**
```c
#define MAHONY_KP  0.3f
#define MAHONY_KI  0.002f
```

**è°ƒå‚è§„åˆ™ï¼š**

| ç°è±¡ | è°ƒæ•´MAHONY_KP | è°ƒæ•´MAHONY_KI |
|------|---------------|---------------|
| å“åº”æ…¢ | å¢å¤§(0.4-0.5) | - |
| æŠ–åŠ¨/éœ‡è¡ | å‡å°(0.2-0.25) | - |
| æœ‰æ¼‚ç§» | - | å¢å¤§(0.003-0.005) |
| æŠ—å¹²æ‰°å·® | å‡å° | å‡å°(0.001-0.0015) |

**æ¨èèŒƒå›´ï¼š**
- **MAHONY_KP:** 0.2-0.5
- **MAHONY_KI:** 0.001-0.005

---

### PDæ–¹å‘ç¯+è§’é€Ÿåº¦ç¯

**ä½ç½®ï¼š** `user/main.c:94`

**åˆå§‹å‚æ•°ï¼š**
```c
pd_init(&pd_direction, 2.5f, 0.8f, 1.2f, 0.3f);
//                    Kp   Kd    Kp_gyro Kd_gyro
```

**è°ƒå‚é¡ºåºï¼š** å…ˆè°ƒå†…ç¯ï¼ˆè§’é€Ÿåº¦ç¯ï¼‰ï¼Œå†è°ƒå¤–ç¯ï¼ˆæ–¹å‘ç¯ï¼‰

#### 1. è§’é€Ÿåº¦ç¯è°ƒå‚ï¼ˆå†…ç¯ï¼‰

**æµ‹è¯•æ–¹æ³•ï¼š** æ‰‹åŠ¨æ—‹è½¬å°è½¦åæ¾æ‰‹ï¼Œè§‚å¯Ÿæ¢å¤é€Ÿåº¦

| ç°è±¡ | è°ƒæ•´kp_gyro | è°ƒæ•´kd_gyro |
|------|-------------|-------------|
| æ¢å¤å¤ªæ…¢ | å¢å¤§(1.5-2.5) | - |
| éœ‡è¡ | å‡å°(0.8-1.2) | å‡å°(0.2-0.3) |
| å“åº”æ…¢ | - | å¢å¤§(0.4-0.6) |

**æ¨èèŒƒå›´ï¼š**
- **kp_gyro:** 0.8-2.5
- **kd_gyro:** 0.2-0.6

#### 2. æ–¹å‘ç¯è°ƒå‚ï¼ˆå¤–ç¯ï¼‰

**æµ‹è¯•æ–¹æ³•ï¼š** èµ›é“å¾ªè¿¹æµ‹è¯•

| ç°è±¡ | è°ƒæ•´Kp | è°ƒæ•´Kd |
|------|-------|-------|
| è½¬å¼¯å“åº”æ…¢ | å¢å¤§(3.0-4.0) | - |
| è½¬å¼¯è¿‡åº¦ | å‡å°(2.0-2.5) | - |
| éœ‡è¡/æŠ–åŠ¨ | å‡å° | å¢å¤§(1.0-1.5) |
| å“åº”æ…¢ | - | å‡å°(0.5-0.8) |

**æ¨èèŒƒå›´ï¼š**
- **Kp:** 2.0-4.0
- **Kd:** 0.5-1.5

---

## å¸¸è§é—®é¢˜æ’æŸ¥

### 1ï¸âƒ£ ç”µæœºç›¸å…³é—®é¢˜

| é—®é¢˜ | å¯èƒ½åŸå›  | è§£å†³æ–¹æ³• |
|------|----------|----------|
| ç”µæœºä¸è½¬ | ç›®æ ‡é€Ÿåº¦ä¸º0 | æ£€æŸ¥ `pid_set_target()` è°ƒç”¨ |
| å•è¾¹è½¬åŠ¨ | ç¼–ç å™¨æ¥çº¿åäº† | äº¤æ¢ç¼–ç å™¨A/Bç›¸ |
| é€Ÿåº¦ä¸ä¸€è‡´ | PIDå‚æ•°ä¸åŒ¹é… | è°ƒæ•´å·¦å³è½®ç‹¬ç«‹å‚æ•° |
| ç”µæœºæŠ–åŠ¨ | Kpè¿‡å¤§ | å‡å°é€Ÿåº¦ç¯Kp |
| åŠ é€Ÿè¿‡æ…¢ | Kiè¿‡å° | å¢å¤§é€Ÿåº¦ç¯Ki |

---

### 2ï¸âƒ£ IMUç›¸å…³é—®é¢˜

| é—®é¢˜ | å¯èƒ½åŸå›  | è§£å†³æ–¹æ³• |
|------|----------|----------|
| IMUåˆå§‹åŒ–å¤±è´¥ | I2Cé€šä¿¡é”™è¯¯ | æ£€æŸ¥I2Cå¼•è„šè¿æ¥ |
| æ•°æ®ä¸æ›´æ–° | ä¸­æ–­æœªå¯ç”¨ | æ£€æŸ¥å®šæ—¶å™¨é…ç½®(10ms) |
| å››å…ƒæ•°æ¨¡é•¿ä¸ä¸º1 | ç®—æ³•é”™è¯¯ | æ£€æŸ¥Mahony_Updateè°ƒç”¨ |
| yawå€¼æ¼‚ç§» | Kiå¤ªå° | å¢å¤§MAHONY_KI |
| yawæŠ–åŠ¨ | Kpå¤ªå¤§ | å‡å°MAHONY_KP |
| è§’é€Ÿåº¦é—­ç¯å¤±æ•ˆ | imu.gyro_zå¼‚å¸¸ | æ£€æŸ¥ä¼ æ„Ÿå™¨æ•°æ® |

---

### 3ï¸âƒ£ å¾ªè¿¹ç›¸å…³é—®é¢˜

| é—®é¢˜ | å¯èƒ½åŸå›  | è§£å†³æ–¹æ³• |
|------|----------|----------|
| æ— æ³•å¾ªè¿¹ | æ¨¡å¼é€‰æ‹©é”™è¯¯ | æ£€æŸ¥ `CONTROL_MODE_CURRENT` |
| å“åº”å¤ªæ…¢ | å‚æ•°è¿‡å° | å¢å¤§SDSDç³»æ•°æˆ–PIDçš„Kp |
| éœ‡è¡/è¶…è°ƒ | å‚æ•°è¿‡å¤§ | å‡å°Kpæˆ–Kd |
| ç›´çº¿æŠ–åŠ¨ | Kdè¿‡å¤§ | å‡å°Kd |
| è½¬å¼¯ä¸è¶³ | Kpè¿‡å° | å¢å¤§Kp |
| æ— æ³•è„±å›° | å¼‚å¸¸å¤„ç†é—®é¢˜ | æ£€æŸ¥ `sensor_check_valid()` |

---

## é™„å½•

### A. é‡è¦æ–‡ä»¶ç´¢å¼•

| æ–‡ä»¶ | åŠŸèƒ½ | å…³é”®å‡½æ•° |
|------|------|----------|
| `task.c` | ä¸»æ§åˆ¶é€»è¾‘ | `motor_control_task()` |
| `quaternion.c` | Mahonyå§¿æ€è§£ç®— | `Mahony_Update()`<br>`Quaternion_ToEuler()` |
| `pid.c` | PID/PDæ§åˆ¶å™¨ | `motor_pid_control()`<br>`pd_direction_gyro_loop()` |
| `control.c` | SDSDç®—æ³• | `SDSD_calculate()` |
| `encoder.c` | ç¼–ç å™¨+æ»¤æ³¢ | `Encoder_Get_Filtered()` |
| `adc.c` | ADCé‡‡é›† | `Adc_Getval_Fast()` |
| `normalization.c` | å½’ä¸€åŒ– | `Normalization()` |
| `motor.c` | ç”µæœºé©±åŠ¨ | `Motor_Left/RightForward/Backward()` |
| `IMU.c` | IMUé©±åŠ¨ | `imu_update()` |

---

### B. å‚æ•°å¿«é€Ÿå‚è€ƒ

**ç”µæœºé€Ÿåº¦ç¯ï¼š**
```c
pid_init(&pid_motor_left, 1.7f, 0.22f, 0.2f);
//       Kp        Ki    Kd
```

**SDSDï¼š**
```c
SDSD_init(&SDSD, 1.0f, 1.0f, 1.0f);
//             A      B      C
pid_init(&pid_SDSD, 2.0f, 0.0f, 0.5f);
//       Kp        Ki    Kd
```

**Mahonyå§¿æ€è§£ç®—ï¼š**
```c
#define MAHONY_KP  0.3f
#define MAHONY_KI  0.002f
```

**PDæ–¹å‘ç¯ï¼š**
```c
pd_init(&pd_direction, 2.5f, 0.8f, 1.2f, 0.3f);
//      Kp   Kd    Kp_gyro Kd_gyro
```

---

### C. æ•°æ®ç»“æ„å‚è€ƒ

**IMUæ•°æ®ç»“æ„ï¼š**
```c
struct IMUData imu;
// åŠ é€Ÿåº¦è®¡ (g)
imu.acc_x, imu.acc_y, imu.acc_z

// é™€èºä»ª (Â°/s)
imu.gyro_x, imu.gyro_y, imu.gyro_z

// å››å…ƒæ•° (æ¨¡é•¿=1)
imu.q0, imu.q1, imu.q2, imu.q3

// æ¬§æ‹‰è§’ (Â°)
imu.roll, imu.pitch, imu.yaw
```

---

### D. è°ƒè¯•ä»£ç ç‰‡æ®µ

**æ‰“å°IMUæ•°æ®ï¼ˆå››å…ƒæ•°+æ¬§æ‹‰è§’ï¼‰ï¼š**
```c
printf("Quaternion: q0=%.3f, q1=%.3f, q2=%.3f, q3=%.3f\r\n",
       imu.q0, imu.q1, imu.q2, imu.q3);
printf("Euler: Roll=%.2f, Pitch=%.2f, Yaw=%.2f\r\n",
       imu.roll, imu.pitch, imu.yaw);
```

**æ‰“å°è§’é€Ÿåº¦å’Œç¼–ç å™¨ï¼š**
```c
printf("Enc L: %d, R: %d | GyroZ: %.2f\r\n",
       encoder_data_dir_L, encoder_data_dir_R, imu.gyro_z);
```

**æ‰“å°ä¼ æ„Ÿå™¨æ•°æ®ï¼š**
```c
Adc_Getval_Fast();
Normalization();
printf("ADC: %d %d %d %d %d\r\n",
       adc_normalized_list[0], adc_normalized_list[1],
       adc_normalized_list[2], adc_normalized_list[3],
       adc_normalized_list[4]);
```

---

## æ€»ç»“

æœ¬æµ‹è¯•æŒ‡å—æ¶µç›–äº†STC32Gæ™ºèƒ½è½¦é¡¹ç›®çš„å®Œæ•´æµ‹è¯•æµç¨‹ï¼š

1. **é˜¶æ®µ1ï¼šé€Ÿåº¦ç¯PIDè°ƒè¯•** â†’ éªŒè¯ç”µæœºé€Ÿåº¦æ§åˆ¶
2. **é˜¶æ®µ2ï¼šSDSDå¾ªè¿¹è°ƒè¯•** â†’ éªŒè¯ç”µç£å¾ªè¿¹
3. **é˜¶æ®µ3ï¼šIMUæ•°æ®éªŒè¯** â†’ éªŒè¯Mahonyå››å…ƒæ•°è§£ç®—
4. **é˜¶æ®µ4ï¼šPDæ–¹å‘ç¯è°ƒè¯•** â†’ éªŒè¯IMUè¾…åŠ©å¾ªè¿¹

**æµ‹è¯•åŸåˆ™ï¼š**
- âœ… ä»ç®€å•åˆ°å¤æ‚ï¼Œé€æ­¥éªŒè¯
- âœ… å…ˆè°ƒå†…ç¯ï¼Œå†è°ƒå¤–ç¯
- âœ… æ¯æ¬¡åªè°ƒæ•´ä¸€ä¸ªå‚æ•°
- âœ… è®°å½•æµ‹è¯•æ•°æ®å’Œè°ƒæ•´è¿‡ç¨‹

**Mahonyç®—æ³•ä¼˜åŠ¿ï¼š**
- âœ… æä¾›æ— æ¼‚ç§»çš„å§¿æ€åŸºå‡†ï¼ˆyawè§’ï¼‰
- âœ… èåˆåŠ é€Ÿåº¦è®¡æ¶ˆé™¤é™€èºä»ªæ¼‚ç§»
- âœ… é€‚åˆé•¿æ—¶é—´è¿è¡Œçš„å¯¼èˆªä»»åŠ¡

ç¥ä½ è°ƒè¯•é¡ºåˆ©ï¼ğŸš—ğŸ’¨
