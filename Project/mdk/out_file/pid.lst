C251 COMPILER V5.60.0,  pid                                                                14/01/26  23:11:44  PAGE 1   


C251 COMPILER V5.60.0, COMPILATION OF MODULE pid
OBJECT MODULE PLACED IN .\out_file\pid.obj
COMPILER INVOKED BY: E:\Tools\keil5\Keil_v5\C251\BIN\C251.EXE ..\code\pid.c LARGE NOALIAS WARNINGLEVEL(3) OPTIMIZE(SIZE)
                    - BROWSE INCDIR(..\..\libraries\zf_common;..\..\libraries\zf_components;..\..\libraries\zf_device;..\..\libraries\zf_driv
                    -er;..\user;..\code) DEBUG PRINT(.\out_file\pid.lst) TABS(2) OBJECT(.\out_file\pid.obj) 

stmt  level    source

    1          //å¤´æ–‡ä»¶åŒ…å«
    2          #include "pid.h"
    3          #include "control.h"
    4          
    5          
    6          // å…¨å±€å˜é‡å®šä¹‰
    7          pid_param_t pid_motor_left;     // å·¦ç”µæœºPIDæ§åˆ¶å™¨
    8          pid_param_t pid_motor_right;    // å³ç”µæœºPIDæ§åˆ¶å™¨
    9          pid_param_t pid_SDSD;           // å·®æ¯”å’Œå·®PIDæ§åˆ¶å™¨
   10          
   11          //-------------------------------------------------------------------------------------------------------
             -------------
   12          // å‡½æ•°ç®€ä»‹     PIDå‚æ•°åˆå§‹åŒ–
   13          // å‚æ•°è¯´æ˜     pid             PIDç»“æ„ä½“æŒ‡é’ˆ
   14          // å‚æ•°è¯´æ˜     kp              æ¯”ä¾‹ç³»æ•°
   15          // å‚æ•°è¯´æ˜     ki              ç§¯åˆ†ç³»æ•°
   16          // å‚æ•°è¯´æ˜     kd              å¾®åˆ†ç³»æ•°
   17          // è¿”å›å‚æ•°     void
   18          // ä½¿ç”¨ç¤ºä¾‹     pid_init(&pid_motor_left, 1.7, 0.22, 0.2);
   19          // å¤‡æ³¨ä¿¡æ¯     åˆå§‹åŒ–PIDæ§åˆ¶å™¨çš„æ‰€æœ‰å‚æ•°å’ŒçŠ¶æ€å˜é‡
   20          //-------------------------------------------------------------------------------------------------------
             -------------
   21          void pid_init(pid_param_t *pid, float kp, float ki, float kd)
   22          {
   23   1          pid->kp = kp;
   24   1          pid->ki = ki;
   25   1          pid->kd = kd;
   26   1      
   27   1          pid->target = 0;
   28   1          pid->actual = 0;
   29   1          pid->error = 0;
   30   1          pid->last_error = 0;
   31   1          pid->prev_error = 0;
   32   1      
   33   1          pid->out_p = 0;
   34   1          pid->out_i = 0;
   35   1          pid->out_d = 0;
   36   1          pid->out = 0;
   37   1      
   38   1          pid->integrator = 0;
   39   1          pid->integral_max = PID_INTEGRAL_MAX;
   40   1          pid->output_max = PID_OUTPUT_MAX;
   41   1          pid->output_min = PID_OUTPUT_MIN;
   42   1      }
   43          
   44          //-------------------------------------------------------------------------------------------------------
             -------------
   45          // å‡½æ•°ç®€ä»‹     è®¾ç½®PIDå‚æ•°
   46          // å‚æ•°è¯´æ˜     pid             PIDç»“æ„ä½“æŒ‡é’ˆ
   47          // å‚æ•°è¯´æ˜     kp              æ¯”ä¾‹ç³»æ•°
   48          // å‚æ•°è¯´æ˜     ki              ç§¯åˆ†ç³»æ•°
   49          // å‚æ•°è¯´æ˜     kd              å¾®åˆ†ç³»æ•°
   50          // è¿”å›å‚æ•°     void
   51          // ä½¿ç”¨ç¤ºä¾‹     pid_set_param(&pid_motor_left, 2.0, 0.3, 0.25);
   52          // å¤‡æ³¨ä¿¡æ¯     åŠ¨æ€è°ƒæ•´PIDå‚æ•°ï¼Œä¸å½±å“å…¶ä»–çŠ¶æ€å˜é‡
   53          //-------------------------------------------------------------------------------------------------------
             -------------
C251 COMPILER V5.60.0,  pid                                                                14/01/26  23:11:44  PAGE 2   

   54          void pid_set_param(pid_param_t *pid, float kp, float ki, float kd)
   55          {
   56   1          pid->kp = kp;
   57   1          pid->ki = ki;
   58   1          pid->kd = kd;
   59   1      }
   60          
   61          //-------------------------------------------------------------------------------------------------------
             -------------
   62          // å‡½æ•°ç®€ä»‹     è®¾ç½®PIDç›®æ ‡å€¼
   63          // å‚æ•°è¯´æ˜     pid             PIDç»“æ„ä½“æŒ‡é’ˆ
   64          // å‚æ•°è¯´æ˜     target          ç›®æ ‡å€¼
   65          // è¿”å›å‚æ•°     void
   66          // ä½¿ç”¨ç¤ºä¾‹     pid_set_target(&pid_motor_left, 100);
   67          // å¤‡æ³¨ä¿¡æ¯     è®¾ç½®PIDæ§åˆ¶å™¨çš„ç›®æ ‡å€¼(æ³¨ï¼šå‡½æ•°å†…éƒ¨å¯¹targetå–è´Ÿ)
   68          //-------------------------------------------------------------------------------------------------------
             -------------
   69          void pid_set_target(pid_param_t *pid, float target)
   70          {
   71   1          pid->target = -target;
   72   1      }
   73          
   74          //-------------------------------------------------------------------------------------------------------
             -------------
   75          // å‡½æ•°ç®€ä»‹     æ¸…é™¤PIDæ•°æ®
   76          // å‚æ•°è¯´æ˜     pid             PIDç»“æ„ä½“æŒ‡é’ˆ
   77          // è¿”å›å‚æ•°     void
   78          // ä½¿ç”¨ç¤ºä¾‹     pid_clear(&pid_motor_left);
   79          // å¤‡æ³¨ä¿¡æ¯     æ¸…é™¤PIDçš„æ‰€æœ‰è¯¯å·®å’Œè¾“å‡ºç´¯è®¡å€¼ï¼Œç”¨äºé‡å¯æ§åˆ¶æˆ–åˆ‡æ¢æ¨¡å¼
   80          //-------------------------------------------------------------------------------------------------------
             -------------
   81          void pid_clear(pid_param_t *pid)
   82          {
   83   1          pid->error = 0;
   84   1          pid->last_error = 0;
   85   1          pid->prev_error = 0;
   86   1          pid->integrator = 0;
   87   1          pid->out = 0;
   88   1          pid->out_p = 0;
   89   1          pid->out_i = 0;
   90   1          pid->out_d = 0;
   91   1      }
   92          
   93          //-------------------------------------------------------------------------------------------------------
             -------------
   94          // å‡½æ•°ç®€ä»‹     é™å¹…å‡½æ•°
   95          // å‚æ•°è¯´æ˜     value           å¾…é™å¹…å€¼
   96          // å‚æ•°è¯´æ˜     min_val         æœ€å°å€¼
   97          // å‚æ•°è¯´æ˜     max_val         æœ€å¤§å€¼
   98          // è¿”å›å‚æ•°     float           é™å¹…åçš„å€¼
   99          // ä½¿ç”¨ç¤ºä¾‹     float result = constrain_float(value, -100, 100);
  100          // å¤‡æ³¨ä¿¡æ¯     å°†è¾“å…¥å€¼é™åˆ¶åœ¨æŒ‡å®šèŒƒå›´å†…
  101          //-------------------------------------------------------------------------------------------------------
             -------------
  102          float constrain_float(float value, float min_val, float max_val)
  103          {
  104   1          if(value <= min_val)
  105   1              return min_val;
  106   1          else if(value >= max_val)
  107   1              return max_val;
  108   1          else
  109   1              return value;
  110   1      }
  111          
  112          //-------------------------------------------------------------------------------------------------------
             -------------
C251 COMPILER V5.60.0,  pid                                                                14/01/26  23:11:44  PAGE 3   

  113          // å‡½æ•°ç®€ä»‹     ä½ç½®å¼PIDè®¡ç®—
  114          // å‚æ•°è¯´æ˜     pid             PIDç»“æ„ä½“æŒ‡é’ˆ
  115          // å‚æ•°è¯´æ˜     actual          å½“å‰å®é™…å€¼
  116          // è¿”å›å‚æ•°     float           PIDè¾“å‡ºå€¼
  117          // ä½¿ç”¨ç¤ºä¾‹     float output = pid_calc_position(&pid_motor_left, encoder_value);
  118          // å¤‡æ³¨ä¿¡æ¯     ä½ç½®å¼PIDï¼Œè¾“å‡ºæ˜¯ç»å¯¹æ§åˆ¶é‡
  119          //-------------------------------------------------------------------------------------------------------
             -------------
  120          float pid_calc_position(pid_param_t *pid, float actual)
  121          {
  122   1          pid->actual = actual;
  123   1          pid->error = pid->target - actual;
  124   1      
  125   1          // ç§¯åˆ†ç´¯è®¡
  126   1          pid->integrator += pid->error;
  127   1      
  128   1          // ç§¯åˆ†é™å¹…
  129   1          pid->integrator = constrain_float(pid->integrator, -pid->integral_max, pid->integral_max);
  130   1      
  131   1          // è®¡ç®—PIDå„é¡¹
  132   1          pid->out_p = pid->kp * pid->error;
  133   1          pid->out_i = pid->ki * pid->integrator;
  134   1          pid->out_d = pid->kd * (pid->error - pid->last_error);
  135   1      
  136   1          // æ›´æ–°è¯¯å·®
  137   1          pid->last_error = pid->error;
  138   1      
  139   1          // è®¡ç®—æ€»è¾“å‡º
  140   1          pid->out = pid->out_p + pid->out_i + pid->out_d;
  141   1      
  142   1          // è¾“å‡ºé™å¹…
  143   1          pid->out = constrain_float(pid->out, pid->output_min, pid->output_max);
  144   1      
  145   1          return pid->out;
  146   1      }
  147          
  148          //-------------------------------------------------------------------------------------------------------
             -------------
  149          // å‡½æ•°ç®€ä»‹     å¢é‡å¼PIDè®¡ç®—
  150          // å‚æ•°è¯´æ˜     pid             PIDç»“æ„ä½“æŒ‡é’ˆ
  151          // å‚æ•°è¯´æ˜     actual          å½“å‰å®é™…å€¼
  152          // è¿”å›å‚æ•°     float           PIDè¾“å‡ºå€¼
  153          // ä½¿ç”¨ç¤ºä¾‹     float output = pid_calc_increment(&pid_motor_left, encoder_value);
  154          // å¤‡æ³¨ä¿¡æ¯     å¢é‡å¼PIDï¼Œè¾“å‡ºæ˜¯æ§åˆ¶é‡çš„å¢é‡ï¼Œéœ€è¦ç´¯åŠ åˆ°ä¹‹å‰çš„è¾“å‡º
  155          //-------------------------------------------------------------------------------------------------------
             -------------
  156          float pid_calc_increment(pid_param_t *pid, float actual)
  157          {
  158   1          float increment;
  159   1      
  160   1          pid->actual = actual;
  161   1          pid->error = pid->target - actual;
  162   1      
  163   1          // è®¡ç®—å¢é‡å¼PIDå„é¡¹
  164   1          // Î”u(k) = Kp[e(k)-e(k-1)] + Ki*e(k) + Kd[e(k)-2e(k-1)+e(k-2)]
  165   1          pid->out_p = pid->kp * (pid->error - pid->last_error);
  166   1          pid->out_i = pid->ki * pid->error;
  167   1          pid->out_d = pid->kd * (pid->error - 2 * pid->last_error + pid->prev_error);
  168   1      
  169   1          // è®¡ç®—å¢é‡
  170   1          increment = pid->out_p + pid->out_i + pid->out_d;
  171   1      
  172   1          // æ›´æ–°è¯¯å·®
  173   1          pid->prev_error = pid->last_error;
  174   1          pid->last_error = pid->error;
  175   1      
C251 COMPILER V5.60.0,  pid                                                                14/01/26  23:11:44  PAGE 4   

  176   1          // ç´¯åŠ è¾“å‡º
  177   1          pid->out += increment;
  178   1      
  179   1          // è¾“å‡ºé™å¹…
  180   1          pid->out = constrain_float(pid->out, pid->output_min, pid->output_max);
  181   1      
  182   1          return pid->out;
  183   1      }
  184          
  185          //-------------------------------------------------------------------------------------------------------
             -------------
  186          // å‡½æ•°ç®€ä»‹     ç”µæœºPIDæ§åˆ¶å‡½æ•°
  187          // å‚æ•°è¯´æ˜     encoder_left    å·¦ç¼–ç å™¨å€¼
  188          // å‚æ•°è¯´æ˜     encoder_right   å³ç¼–ç å™¨å€¼
  189          // è¿”å›å‚æ•°     void
  190          // ä½¿ç”¨ç¤ºä¾‹     motor_pid_control(encoder_left, encoder_right);
  191          // å¤‡æ³¨ä¿¡æ¯     åœ¨å®šæ—¶ä¸­æ–­ä¸­è°ƒç”¨ï¼Œæ ¹æ®ç¼–ç å™¨å€¼è®¡ç®—PWMè¾“å‡ºå¹¶æ§åˆ¶ç”µæœº
  192          //              é¦–å…ˆä½¿ç”¨å·®æ¯”å’Œå·®è¿›è¡Œä½ç½®å¼PIDè®¡ç®—ï¼Œç„¶åä½¿ç”¨å¢é‡å¼PIDæ§åˆ¶ç”µæœºé€
             -Ÿåº¦
  193          //-------------------------------------------------------------------------------------------------------
             -------------
  194          void motor_pid_control(int16 encoder_left, int16 encoder_right)
  195          {
  196   1          float output_left = 0;
  197   1          float output_right = 0;
  198   1          float input_SDSD = 0;
  199   1          float output_SDSD = 0;
  200   1          float final_input_left = 0;
  201   1          float final_input_right = 0;
  202   1      
  203   1          uint8 pwm_left = 0;
  204   1          uint8 pwm_right = 0;
  205   1      
  206   1          // è®¡ç®—å·®æ¯”å’Œå·®å€¼
  207   1          input_SDSD = SDSD_calculate(&SDSD);
  208   1          output_SDSD = pid_calc_position(&pid_SDSD, input_SDSD);
  209   1      
  210   1          // è®¡ç®—å·®é€Ÿåçš„è¾“å…¥å€¼
  211   1          final_input_left = encoder_left + output_SDSD;
  212   1          final_input_right = encoder_right - output_SDSD;
  213   1      
  214   1          // è®¡ç®—å¢é‡å¼PIDè¾“å‡ºï¼ˆå·²ç»èåˆäº†å·®é€Ÿï¼Œ-100~100é™å¹…ï¼‰
  215   1          output_left = pid_calc_increment(&pid_motor_left, final_input_left);
  216   1          output_right = pid_calc_increment(&pid_motor_right, final_input_right);
  217   1      
  218   1          // ===== å·¦ç”µæœºæ§åˆ¶ï¼ˆå¸¦é™å¹…ä¿æŠ¤ï¼‰=====
  219   1          if(output_left >= 0)
  220   1          {
  221   2              pwm_left = (output_left > PID_OUTPUT_MAX) ? PID_OUTPUT_MAX : (uint8)output_left;
  222   2              Motor_LeftForward(pwm_left);
  223   2          }
  224   1          else
  225   1          {
  226   2              pwm_left = ((-output_left) > PID_OUTPUT_MAX) ? PID_OUTPUT_MAX : (uint8)(-output_left);
  227   2              Motor_LeftBackward(pwm_left);
  228   2          }
  229   1      
  230   1          // ===== å³ç”µæœºæ§åˆ¶ï¼ˆå¸¦é™å¹…ä¿æŠ¤ï¼‰=====
  231   1          if(output_right >= 0)
  232   1          {
  233   2              pwm_right = (output_right > PID_OUTPUT_MAX) ? PID_OUTPUT_MAX : (uint8)output_right;
  234   2              Motor_RightForward(pwm_right);
  235   2          }
  236   1          else
  237   1          {
  238   2              pwm_right = ((-output_right) > PID_OUTPUT_MAX) ? PID_OUTPUT_MAX : (uint8)(-output_right);
C251 COMPILER V5.60.0,  pid                                                                14/01/26  23:11:44  PAGE 5   

  239   2              Motor_RightBackward(pwm_right);
  240   2          }
  241   1      }
*** WARNING C183 IN LINE 198 OF ..\code\pid.c: dead assignment eliminated
*** WARNING C183 IN LINE 199 OF ..\code\pid.c: dead assignment eliminated
*** WARNING C183 IN LINE 200 OF ..\code\pid.c: dead assignment eliminated
*** WARNING C183 IN LINE 201 OF ..\code\pid.c: dead assignment eliminated
*** WARNING C183 IN LINE 203 OF ..\code\pid.c: dead assignment eliminated
*** WARNING C183 IN LINE 204 OF ..\code\pid.c: dead assignment eliminated


Module Information          Static   Overlayable
------------------------------------------------
  code size            =      1252     ------
  ecode size           =    ------     ------
  data size            =    ------     ------
  idata size           =    ------     ------
  pdata size           =    ------     ------
  xdata size           =       192         30
  xdata-const size     =    ------     ------
  edata size           =    ------     ------
  bit size             =    ------     ------
  ebit size            =    ------     ------
  bitaddressable size  =    ------     ------
  ebitaddressable size =    ------     ------
  far data size        =    ------     ------
  huge data size       =    ------     ------
  const size           =    ------     ------
  hconst size          =    ------     ------
End of Module Information.


C251 COMPILATION COMPLETE.  6 WARNING(S),  0 ERROR(S)
