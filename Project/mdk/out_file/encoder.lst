C251 COMPILER V5.60.0,  encoder                                                            24/01/26  18:53:03  PAGE 1   


C251 COMPILER V5.60.0, COMPILATION OF MODULE encoder
OBJECT MODULE PLACED IN .\out_file\encoder.obj
COMPILER INVOKED BY: E:\Tools\keil5\Keil_v5\C251\BIN\C251.EXE ..\code\encoder.c LARGE NOALIAS WARNINGLEVEL(3) OPTIMIZE(S
                    -IZE) BROWSE INCDIR(..\..\libraries\zf_common;..\..\libraries\zf_components;..\..\libraries\zf_device;..\..\libraries\zf_
                    -driver;..\user;..\code) DEBUG PRINT(.\out_file\encoder.lst) TABS(2) OBJECT(.\out_file\encoder.obj) 

stmt  level    source

    1          //-------------------------------------------------------------------------------------------------------
             -------------
    2          // 头文件包含
    3          //-------------------------------------------------------------------------------------------------------
             -------------
    4          #include "encoder.h"
    5          
    6          //-------------------------------------------------------------------------------------------------------
             -------------
    7          // 全局变量定义
    8          //-------------------------------------------------------------------------------------------------------
             -------------
    9          int16 encoder_data_dir_L = 0;                                          // 左编码器计数值
   10          int16 encoder_data_dir_R = 0;                                          // 右编码器计数值
   11          
   12          // 一阶IIR低通滤波器状态变量
   13          static float last_encoder_L = 0.0f;                                    // 左编码器上次滤波值
   14          static float last_encoder_R = 0.0f;                                    // 右编码器上次滤波值
   15          
   16          //-------------------------------------------------------------------------------------------------------
             -------------
   17          // 函数简介     编码器初始化
   18          // 参数说明     void
   19          // 返回参数     void
   20          // 使用示例     Encoder_Init();
   21          // 备注信息     初始化左右编码器的硬件接口和滤波器状态
   22          //-------------------------------------------------------------------------------------------------------
             -------------
   23          void Encoder_Init(void)
   24          {
   25   1          encoder_dir_init(ENCODER_DIR_R, ENCODER_DIR_DIR_R, ENCODER_DIR_PULSE_R);
   26   1          encoder_dir_init(ENCODER_DIR_L, ENCODER_DIR_DIR_L, ENCODER_DIR_PULSE_L);
   27   1          last_encoder_L = 0.0f;
   28   1          last_encoder_R = 0.0f;
   29   1      }
   30          
   31          //-------------------------------------------------------------------------------------------------------
             -------------
   32          // 函数简介     一阶IIR低通滤波器
   33          // 参数说明     new_val         新采样值
   34          // 参数说明     last_val        上次滤波值
   35          // 参数说明     alpha           滤波系数 (0.0-1.0), 越小滤波越强
   36          // 返回参数     float           滤波后的值
   37          // 使用示例     filtered = iir_lowpass(new_value, last_value, 0.2f);
   38          // 备注信息     一阶IIR低通滤波器公式: y[n] = alpha * x[n] + (1-alpha) * y[n-1]
   39          //              alpha = 1.0  -> 无滤波, alpha = 0.1  -> 强滤波
   40          //              推荐值: 0.1-0.3
   41          //-------------------------------------------------------------------------------------------------------
             -------------
   42          float iir_lowpass(float new_val, float last_val, float alpha)
   43          {
   44   1          return alpha * new_val + (1.0f - alpha) * last_val;
   45   1      }
   46          
   47          //-------------------------------------------------------------------------------------------------------
             -------------
   48          // 函数简介     获取滤波后的编码器值
C251 COMPILER V5.60.0,  encoder                                                            24/01/26  18:53:03  PAGE 2   

   49          // 参数说明     void
   50          // 返回参数     void
   51          // 使用示例     Encoder_Get_Filtered();
   52          // 备注信息     获取编码器原始值并经过一阶IIR低通滤波
   53          //              滤波系数 alpha = 0.2 (可在函数中调整)
   54          //              在中断中调用，自动完成采集、滤波、清零
   55          //-------------------------------------------------------------------------------------------------------
             -------------
   56          void Encoder_Get_Filtered(void)
   57          {
   58   1          float temp_L, temp_R;
   59   1          float alpha;
   60   1      
   61   1          alpha = 0.2f;
   62   1          temp_L = (float)encoder_get_count(ENCODER_DIR_L);
   63   1          temp_R = (float)encoder_get_count(ENCODER_DIR_R);
   64   1      
   65   1          last_encoder_L = iir_lowpass(temp_L, last_encoder_L, alpha);
   66   1          last_encoder_R = iir_lowpass(temp_R, last_encoder_R, alpha);
   67   1      
   68   1          encoder_data_dir_L = (int16)last_encoder_L;
   69   1          encoder_data_dir_R = (int16)last_encoder_R;
   70   1      
   71   1          encoder_clear_count(ENCODER_DIR_L);
   72   1          encoder_clear_count(ENCODER_DIR_R);
   73   1      }
*** WARNING C183 IN LINE 61 OF ..\code\encoder.c: dead assignment eliminated


Module Information          Static   Overlayable
------------------------------------------------
  code size            =       276     ------
  ecode size           =    ------     ------
  data size            =    ------     ------
  idata size           =    ------     ------
  pdata size           =    ------     ------
  xdata size           =        12          8
  xdata-const size     =    ------     ------
  edata size           =    ------     ------
  bit size             =    ------     ------
  ebit size            =    ------     ------
  bitaddressable size  =    ------     ------
  ebitaddressable size =    ------     ------
  far data size        =    ------     ------
  huge data size       =    ------     ------
  const size           =    ------     ------
  hconst size          =        32     ------
End of Module Information.


C251 COMPILATION COMPLETE.  1 WARNING(S),  0 ERROR(S)
