C251 COMPILER V5.60.0,  motor                                                              18/01/26  23:08:41  PAGE 1   


C251 COMPILER V5.60.0, COMPILATION OF MODULE motor
OBJECT MODULE PLACED IN .\out_file\motor.obj
COMPILER INVOKED BY: E:\Tools\keil5\Keil_v5\C251\BIN\C251.EXE ..\code\motor.c LARGE NOALIAS WARNINGLEVEL(3) OPTIMIZE(SIZ
                    -E) BROWSE INCDIR(..\..\libraries\zf_common;..\..\libraries\zf_components;..\..\libraries\zf_device;..\..\libraries\zf_dr
                    -iver;..\user;..\code) DEBUG PRINT(.\out_file\motor.lst) TABS(2) OBJECT(.\out_file\motor.obj) 

stmt  level    source

    1          /**
    2           * @file    motor.c
    3           * @brief   双路直流电机驱动实现文件
    4           * @details 实现左右两路直流电机的正反转控制、PWM调速，以及风扇控制功能
    5           * @author  Elec3-5adc Team
    6           * @date    2026-01-04
    7           */
    8          
    9          // ==============================================================================
   10          // 头文件包含
   11          // ==============================================================================
   12          #include "motor.h"
   13          
   14          // ==============================================================================
   15          // 全局变量定义
   16          // ==============================================================================
   17          static int8 duty = 0;          // 电机占空比变量 (用于测试)
   18          static int8 dir = 1;           // 电机方向变量 (用于测试, 1:增加, 0:减少)
   19          
   20          // ==============================================================================
   21          // 函数实现
   22          // ==============================================================================
   23          
   24          /**
   25           * @brief  电机GPIO和PWM初始化
   26           * @details 初始化左右电机和风扇的方向控制引脚及PWM通道
   27           *          - 左电机: DIR_L(P32) + PWM_L(P33, PWMA_CH4N)
   28           *          - 右电机: DIR_R(P76) + PWM_R(P75, PWMB_CH2)
   29           *          - 风扇: FAN_IO(P67) + FAN_PWM(P65, PWMA_CH3N)
   30           *          - PWM频率统一设置为17kHz，初始占空比为0%
   31           * @param  None
   32           * @retval None
   33           */
   34          void Motor_Init(void)
   35          {
   36   1          // 左电机初始化
   37   1          gpio_init(DIR_L, GPO, GPIO_LOW, GPO_PUSH_PULL);    // 方向引脚初始化为推挽输出，默认
             -电平
   38   1          pwm_init(PWM_L, MOTOR_PWM_FREQ, 0);                 // PWM通道初始化，频率17kHz，占空比0
   39   1      
   40   1          // 右电机初始化
   41   1          gpio_init(DIR_R, GPO, GPIO_LOW, GPO_PUSH_PULL);    // 方向引脚初始化为推挽输出，默认
             -电平
   42   1          pwm_init(PWM_R, MOTOR_PWM_FREQ, 0);                 // PWM通道初始化，频率17kHz，占空比0
   43   1      
   44   1          // 风扇初始化
   45   1          gpio_init(FAN_IO, GPO, GPIO_LOW, GPO_PUSH_PULL);   // 使能引脚初始化为推挽输出，默认
             -电平
   46   1          pwm_init(FAN_PWM, MOTOR_PWM_FREQ, 0);               // PWM通道初始化，频率17kHz，占空比0
   47   1      }
   48          
   49          /**
   50           * @brief  电机测试函数
   51           * @details 设置左右电机以固定占空比正转，用于验证电机硬件连接和驱动功能
   52           *          - 左电机: DIR_HIGH + 7%占空比
   53           *          - 右电机: DIR_LOW + 7%占空比
   54           * @note   注释代码为占空比自动变化的测试程序，可根据需要启用
C251 COMPILER V5.60.0,  motor                                                              18/01/26  23:08:41  PAGE 2   

   55           * @param  None
   56           * @retval None
   57           */
   58          void Motor_Test(void)
   59          {
   60   1      //    // 左电机正转测试
   61   1      //    gpio_set_level(DIR_L, GPIO_HIGH);                   // 方向引脚置高
   62   1      //    pwm_set_duty(PWM_L, 7 * (PWM_DUTY_MAX / 100));      // 设置占空比为7%
   63   1      
   64   1      //    // 右电机正转测试
   65   1      //    gpio_set_level(DIR_R, GPIO_LOW);                    // 方向引脚置低
   66   1      //    pwm_set_duty(PWM_R, 7 * (PWM_DUTY_MAX / 100));      // 设置占空比为7%
   67   1      
   68   1          // 以下为占空比自动变化的测试代码（已注释）
   69   1          // 根据dir变量自动增减占空比，实现电机加减速测试
   70   1          
   71   1          if(duty >= 0)                                       // 正转
   72   1          {
   73   2      //        gpio_set_level(DIR_L, GPIO_LOW);
   74   2      //        pwm_set_duty(PWM_L, duty * (PWM_DUTY_MAX / 100));
   75   2      
   76   2              gpio_set_level(DIR_R, GPIO_HIGH);
   77   2              pwm_set_duty(PWM_R, duty * (PWM_DUTY_MAX / 100));
   78   2          }
   79   1          else                                                // 反转
   80   1          {
   81   2      //        gpio_set_level(DIR_L, GPIO_HIGH);
   82   2      //        pwm_set_duty(PWM_L, (-duty) * (PWM_DUTY_MAX / 100));
   83   2      
   84   2              gpio_set_level(DIR_R, GPIO_LOW);
   85   2              pwm_set_duty(PWM_R, (-duty) * (PWM_DUTY_MAX / 100));
   86   2          }
   87   1          if(dir)                                             // 根据方向判断增加还是减少（增量
             -编码器参考）
   88   1          {
   89   2              duty++;                                         // 占空比增加
   90   2              if(duty >= MAX_DUTY)                            // 达到最大值
   91   2                  dir = 0;                                    // 改变标志位
   92   2          }
   93   1          else
   94   1          {
   95   2              duty--;                                         // 占空比减少
   96   2              if(duty <= -MAX_DUTY)                           // 达到最小值
   97   2                  dir = 1;                                    // 改变标志位
   98   2          }
   99   1          system_delay_ms(100);
  100   1          
  101   1      }
  102          
  103          /**
  104           * @brief  设置左电机正转
  105           * @details 设置左电机方向为正转(DIR_HIGH)，并设置PWM占空比
  106           * @param  pwm PWM占空比百分比 (范围: 0-100)
  107           * @retval None
  108           */
  109          void Motor_LeftForward(uint8 pwm)
  110          {
  111   1          gpio_set_level(DIR_L, GPIO_HIGH);                   // 方向引脚置高，正转方向
  112   1          pwm_set_duty(PWM_L, pwm * (PWM_DUTY_MAX / 100));    // 设置PWM占空比
  113   1      }
  114          
  115          /**
  116           * @brief  设置右电机正转
  117           * @details 设置右电机方向为正转(DIR_LOW)，并设置PWM占空比
  118           * @param  pwm PWM占空比百分比 (范围: 0-100)
  119           * @retval None
C251 COMPILER V5.60.0,  motor                                                              18/01/26  23:08:41  PAGE 3   

  120           */
  121          void Motor_RightForward(uint8 pwm)
  122          {
  123   1          gpio_set_level(DIR_R, GPIO_HIGH);                    // 方向引脚置低，正转方向
  124   1          pwm_set_duty(PWM_R, pwm * (PWM_DUTY_MAX / 100));    // 设置PWM占空比
  125   1      }
  126          
  127          /**
  128           * @brief  设置左电机反转
  129           * @details 设置左电机方向为反转(DIR_LOW)，并设置PWM占空比
  130           * @param  pwm PWM占空比百分比 (范围: 0-100)
  131           * @retval None
  132           */
  133          void Motor_LeftBackward(uint8 pwm)
  134          {
  135   1          gpio_set_level(DIR_L, GPIO_LOW);                    // 方向引脚置低，反转方向
  136   1          pwm_set_duty(PWM_L, pwm * (PWM_DUTY_MAX / 100));    // 设置PWM占空比
  137   1      }
  138          
  139          /**
  140           * @brief  设置右电机反转
  141           * @details 设置右电机方向为反转(DIR_HIGH)，并设置PWM占空比
  142           * @param  pwm PWM占空比百分比 (范围: 0-100)
  143           * @retval None
  144           */
  145          void Motor_RightBackward(uint8 pwm)
  146          {
  147   1          gpio_set_level(DIR_R, GPIO_LOW);                   // 方向引脚置高，反转方向
  148   1          pwm_set_duty(PWM_R, pwm * (PWM_DUTY_MAX / 100));    // 设置PWM占空比
  149   1      }
  150          
  151          /**
  152           * @brief  设置风扇转速
  153           * @details 设置风扇使能(FAN_IO_HIGH)并调整PWM占空比控制转速
  154           * @param  pwm PWM占空比百分比 (范围: 0-100)
  155           * @retval None
  156           */
  157          void Motor_FanSet(uint8 pwm)
  158          {
  159   1          gpio_set_level(FAN_IO, GPIO_HIGH);                  // 风扇使能引脚置高
  160   1          pwm_set_duty(FAN_PWM, pwm * (PWM_DUTY_MAX / 100));  // 设置PWM占空比控制转速
  161   1      }


Module Information          Static   Overlayable
------------------------------------------------
  code size            =       445     ------
  ecode size           =    ------     ------
  data size            =    ------     ------
  idata size           =    ------     ------
  pdata size           =    ------     ------
  xdata size           =         2     ------
  xdata-const size     =    ------     ------
  edata size           =    ------     ------
  bit size             =    ------     ------
  ebit size            =    ------     ------
  bitaddressable size  =    ------     ------
  ebitaddressable size =    ------     ------
  far data size        =    ------     ------
  huge data size       =    ------     ------
  const size           =    ------     ------
  hconst size          =        12     ------
End of Module Information.


C251 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
