C251 COMPILER V5.60.0,  main                                                               21/01/26  02:20:57  PAGE 1   


C251 COMPILER V5.60.0, COMPILATION OF MODULE main
OBJECT MODULE PLACED IN .\out_file\main.obj
COMPILER INVOKED BY: E:\Tools\keil5\Keil_v5\C251\BIN\C251.EXE ..\user\main.c LARGE NOALIAS WARNINGLEVEL(3) OPTIMIZE(SIZE
                    -) BROWSE INCDIR(..\..\libraries\zf_common;..\..\libraries\zf_components;..\..\libraries\zf_device;..\..\libraries\zf_dri
                    -ver;..\user;..\code) DEBUG PRINT(.\out_file\main.lst) TABS(2) OBJECT(.\out_file\main.obj) 

stmt  level    source

    1          /********************************************************************************************************
             -*************
    2          * STC32G Opensourec Library å³ï¼ˆSTC32G å¼€æºåº“ï¼‰æ˜¯ä¸€ä¸ªåŸºäºå®˜æ–¹ SDK æ¥å£çš„ç¬¬ä¸‰æ–¹å¼€æºåº
             -“
    3          * Copyright (c) 2022 SEEKFREE é€é£ç§‘æŠ€
    4          *
    5          * æœ¬æ–‡ä»¶æ˜¯STC å¼€æºåº“çš„ä¸€éƒ¨åˆ†
    6          *
    7          * STC32G å¼€æºåº“ æ˜¯å…è´¹è½¯ä»¶
    8          * æ‚¨å¯ä»¥æ ¹æ®è‡ªç”±è½¯ä»¶åŸºé‡‘ä¼šå‘å¸ƒçš„ GPLï¼ˆGNU General Public Licenseï¼Œå³ GNUé€šç”¨å…¬å…±è®¸
             -å¯è¯ï¼‰çš„æ¡æ¬¾
    9          * å³ GPL çš„ç¬¬3ç‰ˆï¼ˆå³ GPL3.0ï¼‰æˆ–ï¼ˆæ‚¨é€‰æ‹©çš„ï¼‰ä»»ä½•åæ¥çš„ç‰ˆæœ¬ï¼Œé‡æ–°å‘å¸ƒå’Œ/æˆ–ä¿®æ”
             -¹å®ƒ
   10          *
   11          * æœ¬å¼€æºåº“çš„å‘å¸ƒæ˜¯å¸Œæœ›å®ƒèƒ½å‘æŒ¥ä½œç”¨ï¼Œä½†å¹¶æœªå¯¹å…¶ä½œä»»ä½•çš„ä¿è¯
   12          * ç”šè‡³æ²¡æœ‰éšå«çš„é€‚é”€æ€§æˆ–é€‚åˆç‰¹å®šç”¨é€”çš„ä¿è¯
   13          * æ›´å¤šç»†èŠ‚è¯·å‚è§ GPL
   14          *
   15          * æ‚¨åº”è¯¥åœ¨æ”¶åˆ°æœ¬å¼€æºåº“çš„åŒæ—¶æ”¶åˆ°ä¸€ä»½ GPL çš„å‰¯æœ¬
   16          * å¦‚æœæ²¡æœ‰ï¼Œè¯·å‚é˜…<https://www.gnu.org/licenses/>
   17          *
   18          * é¢å¤–æ³¨æ˜ï¼š
   19          * æœ¬å¼€æºåº“ä½¿ç”¨ GPL3.0 å¼€æºè®¸å¯è¯åè®® ä»¥ä¸Šè®¸å¯ç”³æ˜ä¸ºè¯‘æ–‡ç‰ˆæœ¬
   20          * è®¸å¯ç”³æ˜è‹±æ–‡ç‰ˆåœ¨ libraries/doc æ–‡ä»¶å¤¹ä¸‹çš„ GPL3_permission_statement.txt æ–‡ä»¶ä¸­
   21          * è®¸å¯è¯å‰¯æœ¬åœ¨ libraries æ–‡ä»¶å¤¹ä¸‹ å³è¯¥æ–‡ä»¶å¤¹ä¸‹çš„ LICENSE æ–‡ä»¶
   22          * æ¬¢è¿å„ä½ä½¿ç”¨å¹¶ä¼ æ’­æœ¬ç¨‹åº ä½†ä¿®æ”¹å†…å®¹æ—¶å¿…é¡»ä¿ç•™é€é£ç§‘æŠ€çš„ç‰ˆæƒå£°æ˜ï¼ˆå³æœ¬
             -å£°æ˜ï¼‰
   23          *
   24          * æ–‡ä»¶åç§°
   25          * å…¬å¸åç§°          æˆéƒ½é€é£ç§‘æŠ€æœ‰é™å…¬å¸
   26          * ç‰ˆæœ¬ä¿¡æ¯          æŸ¥çœ‹ libraries/doc æ–‡ä»¶å¤¹å†… version æ–‡ä»¶ ç‰ˆæœ¬è¯´æ˜
   27          * å¼€å‘ç¯å¢ƒ          MDK FOR C251
   28          * é€‚ç”¨å¹³å°          STC32G
   29          * åº—é“ºé“¾æ¥          https://seekfree.taobao.com/
   30          *
   31          * ä¿®æ”¹è®°å½•
   32          * æ—¥æœŸ              ä½œè€…           å¤‡æ³¨
   33          * 2024-08-01        å¤§W            first version
   34          *********************************************************************************************************
             -***********/
   35          
   36          #include "zf_common_headfile.h"
   37          #include "../code/adc.h"
   38          #include "../code/normalization.h"
   39          #include "../code/encoder.h"
   40          #include "../code/IMU.h"
   41          #include "../code/pid.h"
   42          #include "../code/task.h"
   43          
   44          
   45          #define PIT_CH_1                          (TIM1_PIT)                 // ä½¿ç”¨çš„å‘¨æœŸä¸­æ–­ç¼–å· å¦‚æ
             -œä¿®æ”¹ éœ€è¦åŒæ­¥å¯¹åº”ä¿®æ”¹å‘¨æœŸä¸­æ–­ç¼–å·ä¸ isr.c ä¸­çš„è°ƒç”¨
   46          #define PIT_CH_2                          (TIM2_PIT)                 // ä½¿ç”¨çš„å‘¨æœŸä¸­æ–­ç¼–å· å¦‚æ
             -œä¿®æ”¹ éœ€è¦åŒæ­¥å¯¹åº”ä¿®æ”¹å‘¨æœŸä¸­æ–­ç¼–å·ä¸ isr.c ä¸­çš„è°ƒç”¨
   47          
   48          void pit_handler_1(void);
   49          void pit_handler_2(void);
C251 COMPILER V5.60.0,  main                                                               21/01/26  02:20:57  PAGE 2   

   50          
   51          float left_target = 0;                    //å·¦è½®ç›®æ ‡å€¼
   52          float right_target = 0;                 //å³è½®ç›®æ ‡å€¼
   53          uint8 imu_state = 0;                                          // IMUåˆå§‹åŒ–çŠ¶æ€
   54          
   55          void main()
   56          {
   57   1          clock_init(SYSTEM_CLOCK_30M);
   58   1          debug_init();
   59   1      
   60   1          Lcd_Init();
   61   1          key_init();
   62   1          Motor_Init();
   63   1          Adc_All_Init();
   64   1          Encoder_Init();
   65   1      
   66   1          // IMU660RBåˆå§‹åŒ–
   67   1          imu_state = imu_init();
   68   1          if(imu_state == 0)
   69   1          {
   70   2              printf("IMU init success!\r\n");
   71   2          }
   72   1          else
   73   1          {
   74   2              printf("IMU init failed!\r\n");
   75   2          }
   76   1      
   77   1          // ========== æ§åˆ¶å™¨åˆå§‹åŒ– (æ ¹æ® task.h ä¸­çš„ CONTROL_MODE_CURRENT é€‰æ‹©æ¨¡å¼) ==========
   78   1      
   79   1          // SDSDåˆå§‹åŒ– (ç”¨äº SDSD æ§åˆ¶æ¨¡å¼)
   80   1          SDSD_init(&SDSD, 1.0f, 1.0f, 1.0f);
   81   1          pid_init(&pid_SDSD, 2.0f, 0.0f, 0.5f);    // SDSDçš„PIDå‚æ•°: Kp=2.0, Ki=0, Kd=0.5
   82   1          pid_set_target(&pid_SDSD, 0);             // SDSDæœŸæœ›åå·®ä¸º0(å±…ä¸­)
   83   1      
   84   1          // ç”µæœºé€Ÿåº¦ç¯PIDåˆå§‹åŒ– (ä¸¤ç§æ¨¡å¼éƒ½éœ€è¦)
   85   1          pid_init(&pid_motor_left, 1.7f, 0.22f, 0.2f);     // å·¦ç”µæœºPIDå‚æ•°
   86   1          pid_init(&pid_motor_right, 1.7f, 0.1f, 0.0f);     // å³ç”µæœºPIDå‚æ•°
   87   1      
   88   1          // è®¾ç½®ç›®æ ‡é€Ÿåº¦ (å•ä½: ç¼–ç å™¨è®¡æ•°å€¼æ¯10ms)
   89   1          // æ ¹æ®å®é™…æµ‹è¯•è°ƒæ•´ï¼Œå»ºè®®ä»20-50å¼€å§‹
   90   1          pid_set_target(&pid_motor_left, 30.0f);    // å·¦ç”µæœºç›®æ ‡é€Ÿåº¦
   91   1          pid_set_target(&pid_motor_right, 30.0f);   // å³ç”µæœºç›®æ ‡é€Ÿåº¦
   92   1      
   93   1          // PDæ–¹å‘ç¯+è§’é€Ÿåº¦ç¯åˆå§‹åŒ– (ç”¨äº PDæ–¹å‘ç¯æ§åˆ¶æ¨¡å¼)
   94   1          // Kp=2.5, Kd=0.8 (æ–¹å‘ç¯) | Kp_gyro=1.2, Kd_gyro=0.3 (è§’é€Ÿåº¦ç¯)
   95   1          pd_init(&pd_direction, 2.5f, 0.8f, 1.2f, 0.3f);
   96   1      
   97   1      // æ­¤å¤„ç¼–å†™ç”¨æˆ·ä»£ç  ä¾‹å¦‚å¤–è®¾åˆå§‹åŒ–ä»£ç ç­‰
   98   1          tim1_irq_handler = pit_handler_1;             //é‡å†™tim0ä¸­æ–­å¤„ç†å‡½æ•°
   99   1          tim2_irq_handler = pit_handler_2;             //é‡å†™tim0ä¸­æ–­å¤„ç†å‡½æ•°
  100   1      
  101   1          pit_ms_init(PIT_CH_1,10);                   // åˆå§‹åŒ– PIT ä¸ºå‘¨æœŸä¸­æ–­ 10ms å‘¨æœŸ
  102   1          pit_ms_init(PIT_CH_2,50);                   // åˆå§‹åŒ– PIT ä¸ºå‘¨æœŸä¸­æ–­ 10ms å‘¨æœŸ
  103   1      
  104   1          while(1)
  105   1          {
  106   2              // æ­¤å¤„ç¼–å†™éœ€è¦å¾ªç¯æ‰§è¡Œçš„ä»£ç 
  107   2      
  108   2              // è·å–ADCå€¼ (ä½¿ç”¨å¿«é€Ÿå»æå€¼å¹³å‡æ»¤æ³¢ - æ¨è)
  109   2              Adc_Getval_Fast();
  110   2              Normalization();
  111   2      
  112   2              // æ‰“å°å½“å‰æ§åˆ¶æ¨¡å¼å’Œä¼ æ„Ÿå™¨æ•°æ®
  113   2              printf("æ¨¡å¼: %s | ADC: %d,%d,%d,%d,%d\r\n",
  114   2                     get_mode_name(get_control_mode()),
  115   2                     adc_normalized_list[0],
C251 COMPILER V5.60.0,  main                                                               21/01/26  02:20:57  PAGE 3   

  116   2                     adc_normalized_list[1],
  117   2                     adc_normalized_list[2],
  118   2                     adc_normalized_list[3],
  119   2                     adc_normalized_list[4]);
  120   2      
  121   2              // æ‰“å°ç¼–ç å™¨æ•°æ®
  122   2              printf("Encoder: R=%d, L=%d\r\n", encoder_data_dir_R, encoder_data_dir_L);
  123   2      
  124   2              // æ‰“å°IMUæ¬§æ‹‰è§’æ•°æ®
  125   2              printf("IMU: Roll=%.2f, Pitch=%.2f, Yaw=%.2f\r\n",
  126   2                     imu.euler.roll, imu.euler.pitch, imu.euler.yaw);
  127   2      
  128   2              // å»¶æ—¶é¿å…æ‰“å°è¿‡å¿«
  129   2              system_delay_ms(100);
  130   2          }
  131   1      }
  132          //-------------------------------------------------------------------------------------------------------
             -------------
  133          // å‡½æ•°ç®€ä»‹     PIT çš„å‘¨æœŸä¸­æ–­å¤„ç†å‡½æ•° è¿™ä¸ªå‡½æ•°å°†åœ¨ PIT å¯¹åº”çš„å®šæ—¶å™¨ä¸­æ–­è°ƒç”¨
             - è¯¦è§ isr.c
  134          // å‚æ•°è¯´æ˜     void
  135          // è¿”å›å‚æ•°     void
  136          // ä½¿ç”¨ç¤ºä¾‹     pit_handler();
  137          // å¤‡æ³¨ä¿¡æ¯     10mså‘¨æœŸä¸­æ–­ï¼Œå¤„ç†ç¼–ç å™¨é‡‡é›†å’Œç”µæœºæ§åˆ¶
  138          //-------------------------------------------------------------------------------------------------------
             -------------
  139          void pit_handler_1 (void)
  140          {
  141   1          // è°ƒç”¨ç”µæœºæ§åˆ¶ä»»åŠ¡ (å°è£…åœ¨task.cä¸­)
  142   1          // åŠŸèƒ½: ç¼–ç å™¨é‡‡é›† -> ADCåˆ¤æ–­ -> PDæ§åˆ¶ -> ç”µæœºè¾“å‡º
  143   1          motor_control_task();
  144   1      }
  145          
  146          //-------------------------------------------------------------------------------------------------------
             -------------
  147          // å‡½æ•°ç®€ä»‹     PIT çš„å‘¨æœŸä¸­æ–­å¤„ç†å‡½æ•° è¿™ä¸ªå‡½æ•°å°†åœ¨ PIT å¯¹åº”çš„å®šæ—¶å™¨ä¸­æ–­è°ƒç”¨
             - è¯¦è§ isr.c
  148          // å‚æ•°è¯´æ˜     void
  149          // è¿”å›å‚æ•°     void
  150          // ä½¿ç”¨ç¤ºä¾‹     pit_handler();
  151          // å¤‡æ³¨ä¿¡æ¯     50mså‘¨æœŸä¸­æ–­ï¼Œæ›´æ–°IMUæ•°æ®
  152          //-------------------------------------------------------------------------------------------------------
             -------------
  153          void pit_handler_2 (void)
  154          {
  155   1          // è°ƒç”¨IMUæ›´æ–°ä»»åŠ¡ (å°è£…åœ¨task.cä¸­)
  156   1          // åŠŸèƒ½: è·å–IMUåŸå§‹æ•°æ® -> å››å…ƒæ•°è§£ç®— -> æ¬§æ‹‰è§’æ›´æ–°
  157   1          imu_update_task();
  158   1      }


Module Information          Static   Overlayable
------------------------------------------------
  code size            =       700     ------
  ecode size           =    ------     ------
  data size            =    ------     ------
  idata size           =    ------     ------
  pdata size           =    ------     ------
  xdata size           =         9     ------
  xdata-const size     =    ------     ------
  edata size           =    ------     ------
  bit size             =    ------     ------
  ebit size            =    ------     ------
  bitaddressable size  =    ------     ------
  ebitaddressable size =    ------     ------
  far data size        =    ------     ------
  huge data size       =    ------     ------
C251 COMPILER V5.60.0,  main                                                               21/01/26  02:20:57  PAGE 4   

  const size           =    ------     ------
  hconst size          =       161     ------
End of Module Information.


C251 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
