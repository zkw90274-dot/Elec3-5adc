C251 COMPILER V5.60.0,  adc                                                                25/01/26  01:31:18  PAGE 1   


C251 COMPILER V5.60.0, COMPILATION OF MODULE adc
OBJECT MODULE PLACED IN .\out_file\adc.obj
COMPILER INVOKED BY: E:\Tools\keil5\Keil_v5\C251\BIN\C251.EXE ..\code\adc.c LARGE NOALIAS WARNINGLEVEL(3) OPTIMIZE(SIZE)
                    - BROWSE INCDIR(..\..\libraries\zf_common;..\..\libraries\zf_components;..\..\libraries\zf_device;..\..\libraries\zf_driv
                    -er;..\user;..\code) DEBUG PRINT(.\out_file\adc.lst) TABS(2) OBJECT(.\out_file\adc.obj) 

stmt  level    source

    1          //-------------------------------------------------------------------------------------------------------
             -------------
    2          // 头文件包含
    3          //-------------------------------------------------------------------------------------------------------
             -------------
    4          #include "adc.h"
    5          
    6          //-------------------------------------------------------------------------------------------------------
             -------------
    7          // 全局变量定义
    8          //-------------------------------------------------------------------------------------------------------
             -------------
    9          uint16 adc_val_list[CHANNEL_NUMBER] = {0};                      // ADC原始值数组
   10          uint8 channel_index = 0;                                        // 当前通道索引
   11          
   12          // ADC通道枚举数组 - 按从左到右顺序排列
   13          adc_channel_enum channel_list[CHANNEL_NUMBER] =
   14          {
   15              ADC_L1, ADC_L2, ADC_M3, ADC_R4, ADC_R5
   16          };
   17          
   18          // ADC最大最小值校准数组 [偶数索引=最大值, 奇数索引=最小值]
   19          // 需要根据实际传感器校准修改这些值
   20          uint16 max_min_adc[2*CHANNEL_NUMBER] = {
   21              3532, 0,     // L1: 最大值, 最小值
   22              3522, 0,     // L2: 最大值, 最小值
   23              3550, 0,     // M3: 最大值, 最小值
   24              3516, 0,     // R4: 最大值, 最小值
   25              3548, 0,     // R5: 最大值, 最小值
   26          };
   27          
   28          //-------------------------------------------------------------------------------------------------------
             -------------
   29          // 函数简介     ADC全部通道初始化
   30          // 参数说明     void
   31          // 返回参数     void
   32          // 使用示例     Adc_All_Init();
   33          // 备注信息     初始化5个ADC通道为12位精度
   34          //-------------------------------------------------------------------------------------------------------
             -------------
   35          void Adc_All_Init(void)
   36          {
   37   1          adc_init(ADC_L1, ADC_12BIT);         // L1 左侧传感器1
   38   1          adc_init(ADC_L2, ADC_12BIT);         // L2 左侧传感器2
   39   1          adc_init(ADC_M3, ADC_12BIT);         // M3 中间传感器
   40   1          adc_init(ADC_R4, ADC_12BIT);         // R4 右侧传感器4
   41   1          adc_init(ADC_R5, ADC_12BIT);         // R5 右侧传感器5
   42   1      }
   43          
   44          //-------------------------------------------------------------------------------------------------------
             -------------
   45          // 函数简介     ADC值限幅
   46          // 参数说明     adc_val         ADC原始值
   47          // 参数说明     index           通道索引 (0-4)
   48          // 返回参数     uint16          限幅后的ADC值
   49          // 使用示例     uint16 val = limit(adc_val, 0);
   50          // 备注信息     将ADC值限制在校准的最大最小值范围内
C251 COMPILER V5.60.0,  adc                                                                25/01/26  01:31:18  PAGE 2   

   51          //-------------------------------------------------------------------------------------------------------
             -------------
   52          uint16 limit(uint16 adc_val, uint8 index)
   53          {
   54   1          if(adc_val > max_min_adc[2*index])
   55   1          {
   56   2              adc_val = max_min_adc[2*index];
   57   2          }
   58   1          if(adc_val < max_min_adc[2*index+1])
   59   1          {
   60   2              adc_val = max_min_adc[2*index+1];
   61   2          }
   62   1          return adc_val;
   63   1      }
   64          
   65          //-------------------------------------------------------------------------------------------------------
             -------------
   66          // 函数简介     ADC测试函数
   67          // 参数说明     void
   68          // 返回参数     void
   69          // 使用示例     Adc_Test();
   70          // 备注信息     打印所有通道的ADC原始值和平均值滤波后的值
   71          //-------------------------------------------------------------------------------------------------------
             -------------
   72          void Adc_Test(void)
   73          {
   74   1          // 打印原始转换值
   75   1          for(channel_index = 0; channel_index < CHANNEL_NUMBER; channel_index++)
   76   1          {
   77   2              printf("ADC channel %d convert data is %d.\r\n",
   78   2                     channel_index + 1,
   79   2                     adc_convert(channel_list[channel_index]));
   80   2          }
   81   1          system_delay_ms(1000);
   82   1      
   83   1          // 打印平均值滤波后的值
   84   1          for(channel_index = 0; channel_index < CHANNEL_NUMBER; channel_index++)
   85   1          {
   86   2              printf("ADC channel %d mean filter convert data is %d.\r\n",
   87   2                     channel_index + 1,
   88   2                     adc_mean_filter_convert(channel_list[channel_index], 10));
   89   2          }
   90   1          system_delay_ms(500);
   91   1      }
   92          
   93          //-------------------------------------------------------------------------------------------------------
             -------------
   94          // 函数简介     获取所有ADC值并限幅 (使用简单平均滤波)
   95          // 参数说明     void
   96          // 返回参数     void
   97          // 使用示例     Adc_Getval();
   98          // 备注信息     获取5个通道的ADC值，进行10次平均值滤波并限幅
   99          //              结果保存在 adc_val_list[] 数组中
  100          //-------------------------------------------------------------------------------------------------------
             -------------
  101          void Adc_Getval(void)
  102          {
  103   1          for(channel_index = 0; channel_index < CHANNEL_NUMBER; channel_index++)
  104   1          {
  105   2              // 获取ADC值 -> 10次平均值滤波 -> 限幅
  106   2              adc_val_list[channel_index] = limit(
  107   2                  adc_mean_filter_convert(channel_list[channel_index], 10),
  108   2                  channel_index
  109   2              );
  110   2          }
  111   1      }
C251 COMPILER V5.60.0,  adc                                                                25/01/26  01:31:18  PAGE 3   

  112          
  113          //-------------------------------------------------------------------------------------------------------
             -------------
  114          // 函数简介     获取所有ADC值 - 中值滤波版本
  115          // 参数说明     void
  116          // 返回参数     void
  117          // 使用示例     Adc_Getval_Mid();
  118          // 备注信息     使用中值滤波获取ADC值并限幅，适合去除脉冲干扰
  119          //              结果保存在 adc_val_list[] 数组中
  120          //-------------------------------------------------------------------------------------------------------
             -------------
  121          void Adc_Getval_Mid(void)
  122          {
  123   1          for(channel_index = 0; channel_index < CHANNEL_NUMBER; channel_index++)
  124   1          {
  125   2              // 中值滤波 -> 限幅
  126   2              adc_val_list[channel_index] = limit(
  127   2                  adc_mid_sample(channel_list[channel_index]),
  128   2                  channel_index
  129   2              );
  130   2          }
  131   1      }
  132          
  133          //-------------------------------------------------------------------------------------------------------
             -------------
  134          // 函数简介     获取所有ADC值 - 去极值平均滤波版本
  135          // 参数说明     void
  136          // 返回参数     void
  137          // 使用示例     Adc_Getval_Avg();
  138          // 备注信息     使用去极值平均滤波获取ADC值并限幅，抗干扰能力强
  139          //              结果保存在 adc_val_list[] 数组中
  140          //-------------------------------------------------------------------------------------------------------
             -------------
  141          void Adc_Getval_Avg(void)
  142          {
  143   1          for(channel_index = 0; channel_index < CHANNEL_NUMBER; channel_index++)
  144   1          {
  145   2              // 去极值平均滤波 -> 限幅
  146   2              adc_val_list[channel_index] = limit(
  147   2                  adc_sample(channel_list[channel_index]),
  148   2                  channel_index
  149   2              );
  150   2          }
  151   1      }
  152          
  153          //-------------------------------------------------------------------------------------------------------
             -------------
  154          // 函数简介     获取所有ADC值 - 快速去极值平均滤波 (推荐)
  155          // 参数说明     void
  156          // 返回参数     void
  157          // 使用示例     Adc_Getval_Fast();
  158          // 备注信息     使用去极值平均滤波获取ADC值并限幅
  159          //              每通道11次采样，去掉最大最小后取平均
  160          //              总时间约27ms，适合实时控制
  161          //              结果保存在 adc_val_list[] 数组中
  162          //-------------------------------------------------------------------------------------------------------
             -------------
  163          void Adc_Getval_Fast(void)
  164          {
  165   1          for(channel_index = 0; channel_index < CHANNEL_NUMBER; channel_index++)
  166   1          {
  167   2              adc_val_list[channel_index] = limit(
  168   2                  adc_sample(channel_list[channel_index]),
  169   2                  channel_index
  170   2              );
  171   2          }
C251 COMPILER V5.60.0,  adc                                                                25/01/26  01:31:18  PAGE 4   

  172   1      }
  173          
  174          //-------------------------------------------------------------------------------------------------------
             -------------
  175          // 函数简介     获取所有ADC值 - 中值滤波版本
  176          // 参数说明     void
  177          // 返回参数     void
  178          // 使用示例     Adc_Getval_Mid();
  179          // 备注信息     使用中值滤波获取ADC值并限幅
  180          //              每通道3次采样取中值，总时间约7ms，最快
  181          //              结果保存在 adc_val_list[] 数组中
  182          //-------------------------------------------------------------------------------------------------------
             -------------
  183          void Adc_Getval_Quick(void)
  184          {
  185   1          for(channel_index = 0; channel_index < CHANNEL_NUMBER; channel_index++)
  186   1          {
  187   2              adc_val_list[channel_index] = limit(
  188   2                  adc_mid_sample(channel_list[channel_index]),
  189   2                  channel_index
  190   2              );
  191   2          }
  192   1      }
  193          
  194          //=======================================================================================================
             -============
  195          // 多重滤波策略实现
  196          //=======================================================================================================
             -============
  197          
  198          //-------------------------------------------------------------------------------------------------------
             -------------
  199          // 函数简介     中值滤波 (三次采样取中值)
  200          // 参数说明     ch              ADC通道枚举
  201          // 返回参数     uint16          中值滤波后的ADC值
  202          // 使用示例     uint16 val = adc_mid_sample(ADC_L1);
  203          // 备注信息     连续采样3次，取中间值，有效去除脉冲干扰
  204          //-------------------------------------------------------------------------------------------------------
             -------------
  205          uint16 adc_mid_sample(adc_channel_enum ch)
  206          {
  207   1          uint16 i, j, k, tmp;
  208   1      
  209   1          // 采样3次
  210   1          i = adc_convert(ch);
  211   1          j = adc_convert(ch);
  212   1          k = adc_convert(ch);
  213   1      
  214   1          // 选择中值 (三数排序取中间值)
  215   1          if(i > j)
  216   1          {
  217   2              tmp = i;
  218   2              i = j;
  219   2              j = tmp;
  220   2          }
  221   1          if(k > j)
  222   1          {
  223   2              tmp = j;
  224   2          }
  225   1          else if(k > i)
  226   1          {
  227   2              tmp = k;
  228   2          }
  229   1          else
  230   1          {
  231   2              tmp = i;
C251 COMPILER V5.60.0,  adc                                                                25/01/26  01:31:18  PAGE 5   

  232   2          }
  233   1      
  234   1          return tmp;
  235   1      }
  236          
  237          //-------------------------------------------------------------------------------------------------------
             -------------
  238          // 函数简介     去极值平均滤波 (采样11次，去掉最大最小后取平均)
  239          // 参数说明     ch              ADC通道枚举
  240          // 返回参数     uint16          滤波后的ADC值
  241          // 使用示例     uint16 val = adc_sample(ADC_L1);
  242          // 备注信息     采样11次，去除1个最大值和1个最小值，剩余9个取平均
  243          //              优点: 去除极值干扰，平滑信号
  244          //-------------------------------------------------------------------------------------------------------
             -------------
  245          uint16 adc_sample(adc_channel_enum ch)
  246          {
  247   1          uint16 temp, sum, max, min;
  248   1          uint8 i;
  249   1      
  250   1          // 第一次采样
  251   1          temp = adc_convert(ch);
  252   1          max = temp;
  253   1          min = temp;
  254   1          sum = temp;
  255   1      
  256   1          // 继续采样10次
  257   1          for(i = 0; i < 10; i++)
  258   1          {
  259   2              temp = adc_convert(ch);
  260   2              if(max < temp)
  261   2              {
  262   3                  max = temp;
  263   3              }
  264   2              if(min > temp)
  265   2              {
  266   3                  min = temp;
  267   3              }
  268   2              sum += temp;
  269   2          }
  270   1      
  271   1          // 去掉最大值和最小值后求平均 (11-2=9)
  272   1          temp = (sum - max - min) / 9;
  273   1      
  274   1          return temp;
  275   1      }
  276          
  277          //-------------------------------------------------------------------------------------------------------
             -------------
  278          // 函数简介     中值+去极值组合滤波 (中值滤波后再去极值平均)
  279          // 参数说明     ch              ADC通道枚举
  280          // 返回参数     uint16          滤波后的ADC值
  281          // 使用示例     uint16 val = adc_sample_b(ADC_L1);
  282          // 备注信息     先进行三次中值滤波，连续8次中值后再去极值平均
  283          //              优点: 双重滤波，更强的抗干扰能力
  284          //-------------------------------------------------------------------------------------------------------
             -------------
  285          uint16 adc_sample_b(adc_channel_enum ch)
  286          {
  287   1          uint16 temp, sum, max, min;
  288   1          uint8 i;
  289   1      
  290   1          // 第一次中值滤波
  291   1          temp = adc_mid_sample(ch);
  292   1          max = temp;
  293   1          min = temp;
C251 COMPILER V5.60.0,  adc                                                                25/01/26  01:31:18  PAGE 6   

  294   1          sum = temp;
  295   1      
  296   1          // 继续进行7次中值滤波
  297   1          for(i = 1; i <= 7; i++)
  298   1          {
  299   2              temp = adc_mid_sample(ch);
  300   2              if(max < temp)
  301   2              {
  302   3                  max = temp;
  303   3              }
  304   2              if(min > temp)
  305   2              {
  306   3                  min = temp;
  307   3              }
  308   2              sum += temp;
  309   2          }
  310   1      
  311   1          // 去掉最大值和最小值后求平均 (8-2=6)
  312   1          temp = (sum - max - min) / 6;
  313   1      
  314   1          return temp;
  315   1      }
  316          
  317          //-------------------------------------------------------------------------------------------------------
             -------------
  318          // 函数简介     7元素冒泡排序
  319          // 参数说明     arr             7元素数组指针
  320          // 返回参数     uint16          排序后数组的首地址
  321          // 使用示例     arr[0] = sort_seven(arr);
  322          // 备注信息     对7个元素进行冒泡排序，中值位于arr[3]
  323          //-------------------------------------------------------------------------------------------------------
             -------------
  324          uint16 sort_seven(uint16 arr[])
  325          {
  326   1          uint8 i, j;
  327   1          uint16 temp;
  328   1      
  329   1          // 冒泡排序 (降序)
  330   1          for(i = 0; i < 6; i++)
  331   1          {
  332   2              for(j = 0; j < 6 - i; j++)
  333   2              {
  334   3                  if(arr[j] < arr[j + 1])
  335   3                  {
  336   4                      temp = arr[j];
  337   4                      arr[j] = arr[j + 1];
  338   4                      arr[j + 1] = temp;
  339   4                  }
  340   3              }
  341   2          }
  342   1      
  343   1          // 返回中值 arr[3]
  344   1          return arr[3];
  345   1      }
  346          
  347          //-------------------------------------------------------------------------------------------------------
             -------------
  348          // 函数简介     排序取中值滤波 (7次采样排序后取中值)
  349          // 参数说明     ch              ADC通道枚举
  350          // 返回参数     uint16          中值
  351          // 使用示例     uint16 val = adc_sample_a(ADC_L1);
  352          // 备注信息     采样7次，排序后取第4个值(中值)
  353          //-------------------------------------------------------------------------------------------------------
             -------------
  354          uint16 adc_sample_a(adc_channel_enum ch)
  355          {
C251 COMPILER V5.60.0,  adc                                                                25/01/26  01:31:18  PAGE 7   

  356   1          uint8 i;
  357   1          uint16 arr[7];
  358   1      
  359   1          // 采样7次
  360   1          for(i = 0; i < 7; i++)
  361   1          {
  362   2              arr[i] = adc_convert(ch);
  363   2          }
  364   1      
  365   1          // 排序并返回中值
  366   1          arr[0] = sort_seven(arr);
  367   1          return arr[0];
  368   1      }


Module Information          Static   Overlayable
------------------------------------------------
  code size            =      1178     ------
  ecode size           =    ------     ------
  data size            =    ------     ------
  idata size           =    ------     ------
  pdata size           =    ------     ------
  xdata size           =        41         32
  xdata-const size     =    ------     ------
  edata size           =    ------     ------
  bit size             =    ------     ------
  ebit size            =    ------     ------
  bitaddressable size  =    ------     ------
  ebitaddressable size =    ------     ------
  far data size        =    ------     ------
  huge data size       =    ------     ------
  const size           =    ------     ------
  hconst size          =       147     ------
End of Module Information.


C251 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
