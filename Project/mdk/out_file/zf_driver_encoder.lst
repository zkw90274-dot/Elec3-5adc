C251 COMPILER V5.60.0,  zf_driver_encoder                                                  08/01/26  02:12:46  PAGE 1   


C251 COMPILER V5.60.0, COMPILATION OF MODULE zf_driver_encoder
OBJECT MODULE PLACED IN .\out_file\zf_driver_encoder.obj
COMPILER INVOKED BY: E:\Tools\keil5\Keil_v5\C251\BIN\C251.EXE ..\..\libraries\zf_driver\zf_driver_encoder.c LARGE NOALIA
                    -S WARNINGLEVEL(3) OPTIMIZE(SIZE) BROWSE INCDIR(..\..\libraries\zf_common;..\..\libraries\zf_components;..\..\libraries\z
                    -f_device;..\..\libraries\zf_driver;..\user;..\code) DEBUG PRINT(.\out_file\zf_driver_encoder.lst) TABS(2) OBJECT(.\out_f
                    -ile\zf_driver_encoder.obj) 

stmt  level    source

    1          /********************************************************************************************************
             -*************
    2          * STC32G Opensourec Library ¼´£¨STC32G ¿ªÔ´¿â£©ÊÇÒ»¸ö»ùÓÚ¹Ù·½ SDK ½Ó¿ÚµÄµÚÈý·½¿ªÔ´¿â
    3          * Copyright (c) 2022 SEEKFREE Öð·É¿Æ¼¼
    4          *
    5          * ±¾ÎÄ¼þÊÇSTC ¿ªÔ´¿âµÄÒ»²¿·Ö
    6          *
    7          * STC32G ¿ªÔ´¿â ÊÇÃâ·ÑÈí¼þ
    8          * Äú¿ÉÒÔ¸ù¾Ý×ÔÓÉÈí¼þ»ù½ð»á·¢²¼µÄ GPL£¨GNU General Public License£¬¼´ GNUÍ¨ÓÃ¹«¹²Ðí¿ÉÖ¤£©µÄÌõ¿î
    9          * ¼´ GPL µÄµÚ3°æ£¨¼´ GPL3.0£©»ò£¨ÄúÑ¡ÔñµÄ£©ÈÎºÎºóÀ´µÄ°æ±¾£¬ÖØÐÂ·¢²¼ºÍ/»òÐÞ¸ÄËü
   10          *
   11          * ±¾¿ªÔ´¿âµÄ·¢²¼ÊÇÏ£ÍûËüÄÜ·¢»Ó×÷ÓÃ£¬µ«²¢Î´¶ÔÆä×÷ÈÎºÎµÄ±£Ö¤
   12          * ÉõÖÁÃ»ÓÐÒþº¬µÄÊÊÏúÐÔ»òÊÊºÏÌØ¶¨ÓÃÍ¾µÄ±£Ö¤
   13          * ¸ü¶àÏ¸½ÚÇë²Î¼û GPL
   14          *
   15          * ÄúÓ¦¸ÃÔÚÊÕµ½±¾¿ªÔ´¿âµÄÍ¬Ê±ÊÕµ½Ò»·Ý GPL µÄ¸±±¾
   16          * Èç¹ûÃ»ÓÐ£¬Çë²ÎÔÄ<https://www.gnu.org/licenses/>
   17          *
   18          * ¶îÍâ×¢Ã÷£º
   19          * ±¾¿ªÔ´¿âÊ¹ÓÃ GPL3.0 ¿ªÔ´Ðí¿ÉÖ¤Ð­Òé ÒÔÉÏÐí¿ÉÉêÃ÷ÎªÒëÎÄ°æ±¾
   20          * Ðí¿ÉÉêÃ÷Ó¢ÎÄ°æÔÚ libraries/doc ÎÄ¼þ¼ÐÏÂµÄ GPL3_permission_statement.txt ÎÄ¼þÖÐ
   21          * Ðí¿ÉÖ¤¸±±¾ÔÚ libraries ÎÄ¼þ¼ÐÏÂ ¼´¸ÃÎÄ¼þ¼ÐÏÂµÄ LICENSE ÎÄ¼þ
   22          * »¶Ó­¸÷Î»Ê¹ÓÃ²¢´«²¥±¾³ÌÐò µ«ÐÞ¸ÄÄÚÈÝÊ±±ØÐë±£ÁôÖð·É¿Æ¼¼µÄ°æÈ¨ÉùÃ÷£¨¼´±¾ÉùÃ÷£©
   23          *
   24          * ÎÄ¼þÃû³Æ          
   25          * ¹«Ë¾Ãû³Æ          ³É¶¼Öð·É¿Æ¼¼ÓÐÏÞ¹«Ë¾
   26          * °æ±¾ÐÅÏ¢          ²é¿´ libraries/doc ÎÄ¼þ¼ÐÄÚ version ÎÄ¼þ °æ±¾ËµÃ÷
   27          * ¿ª·¢»·¾³          MDK FOR C251
   28          * ÊÊÓÃÆ½Ì¨          STC32G
   29          * µêÆÌÁ´½Ó          https://seekfree.taobao.com/
   30          *
   31          * ÐÞ¸Ä¼ÇÂ¼
   32          * ÈÕÆÚ              ×÷Õß           ±¸×¢
   33          * 2024-08-01        ´óW            first version
   34          *********************************************************************************************************
             -***********/
   35          #include "zf_driver_gpio.h"
   36          #include "zf_driver_encoder.h"
   37          
   38          static volatile uint8 encoder_dir_pin[6] = { 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF};
   39          
   40          //-------------------------------------------------------------------------------------------------------
             -------------
   41          // º¯Êý¼ò½é     ¶¨Ê±Æ÷±àÂëÆ÷½âÂëÈ¡Öµ
   42          // ²ÎÊýËµÃ÷     encoder_n      ¶¨Ê±Æ÷Ã¶¾ÙÌå
   43          // ·µ»Ø²ÎÊý     void
   44          // ±¸×¢ÐÅÏ¢
   45          // Ê¹ÓÃÊ¾Àý    encoder_get_count(TIM2_ENCOEDER)  // »ñÈ¡¶¨Ê±Æ÷2µÄ²É¼¯µ½µÄ±àÂëÆ÷Êý¾Ý
   46          //-------------------------------------------------------------------------------------------------------
             -------------
   47          int16 encoder_get_count(encoder_index_enum encoder_n)
   48          {
   49   1          int16 dat = 0;
   50   1          switch(encoder_n)
   51   1          {
   52   2              case TIM0_ENCOEDER:
C251 COMPILER V5.60.0,  zf_driver_encoder                                                  08/01/26  02:12:46  PAGE 2   

   53   2              {
   54   3                  dat = (uint16)TH0 << 8;
   55   3                  dat = ((uint8)TL0) | dat;
   56   3                  break;
   57   3              }
   58   2              case TIM1_ENCOEDER:
   59   2              {
   60   3                  dat = (uint16)TH1 << 8;
   61   3                  dat = ((uint8)TL1) | dat;
   62   3                  break;
   63   3              }
   64   2              case TIM2_ENCOEDER:
   65   2              {
   66   3                  dat = (uint16)T2H << 8;
   67   3                  dat = ((uint8)T2L) | dat;
   68   3                  break;
   69   3              }
   70   2              case TIM3_ENCOEDER:
   71   2              {
   72   3                  dat = (uint16)T3H << 8;
   73   3                  dat = ((uint8)T3L) | dat;
   74   3                  break;
   75   3              }
   76   2              case TIM4_ENCOEDER:
   77   2              {
   78   3                  dat = (uint16)T4H << 8;
   79   3                  dat = ((uint8)T4L) | dat;
   80   3                  break;
   81   3              }
   82   2          }
   83   1          if(gpio_get_level(encoder_dir_pin[encoder_n]))
   84   1          {
   85   2              return (-dat);
   86   2          }
   87   1          return dat;
   88   1      }
   89          
   90          //-------------------------------------------------------------------------------------------------------
             -------------
   91          // º¯Êý¼ò½é     ¶¨Ê±Æ÷µÄ¼ÆÊýÆ÷Çå¿Õ
   92          // ²ÎÊýËµÃ÷     encoder_n      ¶¨Ê±Æ÷Ã¶¾ÙÌå
   93          // ·µ»Ø²ÎÊý     void
   94          // ±¸×¢ÐÅÏ¢
   95          // Ê¹ÓÃÊ¾Àý    encoder_clear_count(TIM1_ENCOEDER)  //Çå³ý¶¨Ê±Æ÷1²É¼¯µ½µÄ±àÂëÆ÷Êý¾Ý
   96          //-------------------------------------------------------------------------------------------------------
             -------------
   97          void encoder_clear_count(encoder_index_enum encoder_n)
   98          {
   99   1          switch(encoder_n)
  100   1          {
  101   2              case TIM0_ENCOEDER:
  102   2              {
  103   3                  TR0 = 0;
  104   3                  TH0 = 0;
  105   3                  TL0 = 0;
  106   3                  TR0 = 1;
  107   3                  break;
  108   3              }
  109   2              case TIM1_ENCOEDER:
  110   2              {
  111   3                  TR1 = 0;
  112   3                  TH1 = 0;
  113   3                  TL1 = 0;
  114   3                  TR1 = 1;
  115   3                  break;
  116   3              }
C251 COMPILER V5.60.0,  zf_driver_encoder                                                  08/01/26  02:12:46  PAGE 3   

  117   2              case TIM2_ENCOEDER:
  118   2              {
  119   3                  AUXR &= ~(1 << 4);
  120   3                  T2H = 0;
  121   3                  T2L = 0;
  122   3                  AUXR |= 1 << 4;
  123   3                  break;
  124   3              }
  125   2              case TIM3_ENCOEDER:
  126   2              {
  127   3                  T4T3M &= ~(1 << 3);
  128   3                  T3H = 0;
  129   3                  T3L = 0;
  130   3                  T4T3M |= (1 << 3);
  131   3                  break;
  132   3              }
  133   2              case TIM4_ENCOEDER:
  134   2              {
  135   3                  T4T3M &= ~(1 << 7);
  136   3                  T4H = 0;
  137   3                  T4L = 0;
  138   3                  T4T3M |= (1 << 7);
  139   3                  break;
  140   3              }
  141   2          }
  142   1      }
  143          
  144          //-------------------------------------------------------------------------------------------------------
             -------------
  145          // º¯Êý¼ò½é     ±àÂëÆ÷½âÂë³õÊ¼»¯
  146          // ²ÎÊýËµÃ÷     timer_ch        ¶¨Ê±Æ÷Ã¶¾ÙÌå
  147          // ²ÎÊýËµÃ÷     lsb_pin         ±àÂëÆ÷Âö³åÒý½Å
  148          // ²ÎÊýËµÃ÷     dir_pin         ±àÂëÆ÷·½ÏòÒý½Å
  149          // ·µ»Ø²ÎÊý     void
  150          //          ÍÆ¼öÊ¹ÓÃ´ø·½Ïò½âÂë±àÂëÆ÷¡£
  151          // Ê¹ÓÃÊ¾Àý      encoder_init_dir(TIM1_ENCOEDER, TIM1_CH1_ENCOEDER_E9, TIM1_CH2_ENCOEDER_E11)
  152          //                              // Ê¹ÓÃ¶¨Ê±Æ÷1 ×ö´ø·½ÏòµÄ±àÂëÆ÷½âÂë£¬ Í¨µÀ1·½ÏòÐÅºÅÒý½ÅE9£¬Í¨µÀ2Âö³åÐÅºÅÒ
             -ý½ÅE11
  153          //-------------------------------------------------------------------------------------------------------
             -------------
  154          void encoder_dir_init(encoder_index_enum encoder_n, gpio_pin_enum dir_pin, encoder_channel_enum lsb_pin)
  155          {
  156   1          // Èç¹û³ÌÐòÔÚÊä³öÁË¶ÏÑÔÐÅÏ¢ ²¢ÇÒÌáÊ¾³ö´íÎ»ÖÃÔÚÕâÀï
  157   1          // ¾ÍÈ¥²é¿´ÄãÔÚÊ²Ã´µØ·½µ÷ÓÃÕâ¸öº¯Êý ¼ì²éÄãµÄ´«Èë²ÎÊý
  158   1          // ÕâÀïÊÇ¼ì²éÊÇ·ñÓÐÖØ¸´Ê¹ÓÃ¶¨Ê±Æ÷
  159   1          // ±ÈÈç³õÊ¼»¯ÁË TIM1_PWM È»ºóÓÖ³õÊ¼»¯³É TIM1_ENCODER ÕâÖÖÓÃ·¨ÊÇ²»ÔÊÐíµÄ
  160   1          zf_assert(timer_funciton_check(encoder_n, TIMER_FUNCTION_ENCODER));
  161   1          zf_assert((dir_pin >> 8) == 0x00);
  162   1          zf_assert((lsb_pin >> 8) == encoder_n);
  163   1          // ³õÊ¼»¯·½ÏòÒý½Å
  164   1          gpio_init(dir_pin, GPI, 0, GPI_PULL_UP);
  165   1          gpio_init(lsb_pin&0xFF, GPI, 0, GPI_PULL_UP);
  166   1          encoder_dir_pin[encoder_n] = dir_pin;                               // ½«·½ÏòÒý½ÅºÅ´æÈëÊý×éÖÐ
  167   1          switch(encoder_n)
  168   1          {
  169   2              case TIM0_ENCOEDER:
  170   2              {
  171   3                  TL0 = 0;
  172   3                  TH0 = 0;
  173   3                  TMOD |= 0x04; //Íâ²¿¼ÆÊýÄ£Ê½
  174   3                  TR0 = 1; //Æô¶¯¶¨Ê±Æ÷
  175   3                  break;
  176   3              }
  177   2              case TIM1_ENCOEDER:
  178   2              {
  179   3                  TL1 = 0x00;
C251 COMPILER V5.60.0,  zf_driver_encoder                                                  08/01/26  02:12:46  PAGE 4   

  180   3                  TH1 = 0x00;
  181   3                  TMOD |= 0x40; // Íâ²¿¼ÆÊýÄ£Ê½
  182   3                  TR1 = 1; // Æô¶¯¶¨Ê±Æ÷
  183   3                  break;
  184   3              }
  185   2              case TIM2_ENCOEDER:
  186   2              {
  187   3                  T2L = 0x00;
  188   3                  T2H = 0x00;
  189   3                  AUXR |= 0x18; // ÉèÖÃÍâ²¿¼ÆÊýÄ£Ê½²¢Æô¶¯¶¨Ê±Æ÷
  190   3                  break;
  191   3              }
  192   2              case TIM3_ENCOEDER:
  193   2              {
  194   3                  T3L = 0;
  195   3                  T3H = 0;
  196   3                  T4T3M |= 0x0c; // ÉèÖÃÍâ²¿¼ÆÊýÄ£Ê½²¢Æô¶¯¶¨Ê±Æ÷
  197   3                  break;
  198   3              }
  199   2              case TIM4_ENCOEDER:
  200   2              {
  201   3                  T4L = 0;
  202   3                  T4H = 0;
  203   3                  T4T3M |= 0xc0; // ÉèÖÃÍâ²¿¼ÆÊýÄ£Ê½²¢Æô¶¯¶¨Ê±Æ÷
  204   3                  break;
  205   3              }
  206   2          }
  207   1      }


Module Information          Static   Overlayable
------------------------------------------------
  code size            =       407     ------
  ecode size           =    ------     ------
  data size            =    ------     ------
  idata size           =    ------     ------
  pdata size           =    ------     ------
  xdata size           =         6          2
  xdata-const size     =    ------     ------
  edata size           =    ------     ------
  bit size             =    ------     ------
  ebit size            =    ------     ------
  bitaddressable size  =    ------     ------
  ebitaddressable size =    ------     ------
  far data size        =    ------     ------
  huge data size       =    ------     ------
  const size           =    ------     ------
  hconst size          =        57     ------
End of Module Information.


C251 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
